<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ĞĞ½Ğ°Ğ»Ğ¸Ñ‚Ğ¸ĞºĞ° Ğ¼Ğ°Ñ€ĞºĞµÑ‚Ğ¿Ğ»ĞµĞ¹ÑĞ¾Ğ²</title>
<link rel="stylesheet" href="styles.css">
<style>
  /* â”€â”€ Ğ”Ğ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğµ ÑÑ‚Ğ¸Ğ»Ğ¸ Ğ´Ğ»Ñ Ğ²ĞºĞ»Ğ°Ğ´Ğ¾Ğº Ğ¸ Ñ„Ğ¾Ñ€Ğ¼ â”€â”€ */
  .tabs {
    display: flex;
    background: var(--bg-card);
    border-bottom: 1px solid var(--line);
    position: sticky;
    top: 0;
    z-index: 100;
  }
  .tab-btn {
    flex: 1;
    padding: 14px 8px;
    text-align: center;
    cursor: pointer;
    font-weight: 700;
    font-size: 13px;
    color: var(--text-soft);
    border-bottom: 2px solid transparent;
    transition: all 0.2s;
    background: none;
    border-top: none;
    border-left: none;
    border-right: none;
    font-family: inherit;
  }
  .tab-btn.active {
    color: var(--cyan);
    border-bottom-color: var(--cyan);
    background: rgba(89,156,255,0.06);
  }

  .tab-panel { display: none; padding: 16px; }
  .tab-panel.active { display: block; }

  /* KPI ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºĞ¸ */
  .kpi-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-bottom: 14px;
  }
  .kpi-card {
    background: var(--bg-card-strong);
    border: 1px solid var(--line);
    border-radius: 14px;
    padding: 14px;
  }
  .kpi-label {
    font-size: 11px;
    color: var(--text-soft);
    margin-bottom: 6px;
  }
  .kpi-value {
    font-size: 22px;
    font-weight: 800;
    line-height: 1;
    margin-bottom: 4px;
    color: var(--text-main);
  }
  .kpi-delta {
    font-size: 11px;
    font-weight: 600;
  }
  .delta-up   { color: var(--green); }
  .delta-down { color: var(--orange); }
  .delta-warn { color: var(--yellow); }

  /* ĞŸÑ€Ğ¾Ğ³Ñ€ĞµÑÑ-Ğ±Ğ°Ñ€Ñ‹ */
  .bar-card {
    background: var(--bg-card-strong);
    border: 1px solid var(--line);
    border-radius: 12px;
    padding: 12px 14px;
    margin-bottom: 8px;
  }
  .bar-header {
    display: flex;
    justify-content: space-between;
    font-size: 12px;
    color: var(--text-soft);
    margin-bottom: 8px;
  }
  .bar-header strong { color: var(--text-main); }
  .bar-track {
    height: 6px;
    background: var(--line);
    border-radius: 6px;
    overflow: hidden;
  }
  .bar-fill {
    height: 100%;
    border-radius: 6px;
    background: linear-gradient(90deg, var(--cyan), var(--mint));
    transition: width 0.8s ease;
  }
  .bar-fill.warn { background: linear-gradient(90deg, var(--yellow), var(--orange)); }

  /* ĞĞ»ĞµÑ€Ñ‚Ñ‹ */
  .alert-card {
    background: rgba(255,139,87,0.1);
    border: 1px solid rgba(255,139,87,0.3);
    border-radius: 12px;
    padding: 12px 14px;
    margin-bottom: 10px;
    font-size: 13px;
    line-height: 1.5;
  }
  .alert-card .alert-title { color: var(--orange); font-weight: 700; margin-bottom: 4px; }

  /* Ğ¡ĞµĞºÑ†Ğ¸Ğ¸ */
  .section-title {
    font-size: 11px;
    font-weight: 700;
    color: var(--text-soft);
    letter-spacing: 0.1em;
    text-transform: uppercase;
    margin: 20px 0 10px;
  }
  .section-card {
    background: var(--bg-card);
    border: 1px solid var(--line);
    border-radius: 16px;
    padding: 16px;
    margin-bottom: 14px;
  }

  /* Ğ¤Ğ¾Ñ€Ğ¼Ñ‹ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞº */
  .form-label {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 12px;
    color: var(--text-soft);
    margin-bottom: 6px;
  }
  .form-input {
    width: 100%;
    background: var(--bg-card-strong);
    border: 1px solid var(--line);
    border-radius: 10px;
    padding: 12px 14px;
    color: var(--text-main);
    font-size: 14px;
    font-family: inherit;
    outline: none;
    margin-bottom: 10px;
    transition: border-color 0.2s;
    -webkit-appearance: none;
  }
  .form-input:focus { border-color: var(--cyan); }
  .form-input::placeholder { color: var(--text-soft); opacity: 0.6; }

  .save-btn {
    width: 100%;
    padding: 13px;
    background: linear-gradient(135deg, var(--cyan), var(--mint));
    border: none;
    border-radius: 12px;
    color: #0a1628;
    font-weight: 800;
    font-size: 14px;
    cursor: pointer;
    font-family: inherit;
    transition: opacity 0.2s;
    margin-top: 2px;
  }
  .save-btn:active { opacity: 0.8; }
  .save-btn:disabled { opacity: 0.5; cursor: default; }

  .hint-box {
    background: rgba(89,156,255,0.08);
    border-radius: 10px;
    padding: 10px 12px;
    font-size: 12px;
    color: var(--text-soft);
    line-height: 1.6;
    margin-bottom: 14px;
  }
  .hint-box a { color: var(--cyan); text-decoration: none; }

  .badge-ok {
    display: inline-block;
    background: rgba(102,206,195,0.2);
    color: var(--mint);
    border-radius: 20px;
    padding: 1px 8px;
    font-size: 11px;
    font-weight: 700;
  }
  .badge-no {
    display: inline-block;
    background: rgba(255,139,87,0.15);
    color: var(--orange);
    border-radius: 20px;
    padding: 1px 8px;
    font-size: 11px;
    font-weight: 700;
  }

  .divider { border: none; border-top: 1px solid var(--line); margin: 18px 0; }

  /* Ğ¡Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ */
  .state-box {
    text-align: center;
    padding: 48px 20px;
    color: var(--text-soft);
  }
  .state-box .icon { font-size: 40px; margin-bottom: 12px; }
  .state-box p { font-size: 14px; line-height: 1.5; }
  .state-box small { font-size: 12px; opacity: 0.7; }

  /* ĞŸĞ»Ğ°Ñ‚Ñ„Ğ¾Ñ€Ğ¼Ğ°-ÑˆĞ°Ğ¿ĞºĞ° */
  .platform-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 16px;
    padding-bottom: 12px;
    border-bottom: 1px solid var(--line);
  }
  .platform-dot {
    width: 10px; height: 10px;
    border-radius: 50%;
  }
  .platform-dot.ozon { background: #5b9fff; }
  .platform-dot.wb   { background: #cb11ab; }
  .platform-name { font-weight: 700; font-size: 15px; }
  .platform-updated { font-size: 11px; color: var(--text-soft); margin-left: auto; }

  .refresh-btn {
    background: none;
    border: 1px solid var(--line);
    border-radius: 8px;
    color: var(--text-soft);
    font-size: 12px;
    padding: 5px 12px;
    cursor: pointer;
    font-family: inherit;
    transition: border-color 0.2s;
  }
  .refresh-btn:hover { border-color: var(--cyan); color: var(--cyan); }
</style>
</head>
<body>

<!-- Ğ’ĞšĞ›ĞĞ”ĞšĞ˜ -->
<div class="tabs">
  <button class="tab-btn active" onclick="switchTab('ozon')">ğŸ”µ Ozon</button>
  <button class="tab-btn" onclick="switchTab('wb')">ğŸŸ£ WB</button>
  <button class="tab-btn" onclick="switchTab('settings')">âš™ï¸ ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸</button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• Ğ’ĞšĞ›ĞĞ”ĞšĞ OZON â•â•â•â•â•â•â•â•â•â• -->
<div id="panel-ozon" class="tab-panel active">
  <div id="ozon-content">
    <div class="state-box">
      <div class="icon">â³</div>
      <p>Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ozon...</p>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• Ğ’ĞšĞ›ĞĞ”ĞšĞ WB â•â•â•â•â•â•â•â•â•â• -->
<div id="panel-wb" class="tab-panel">
  <div id="wb-content">
    <div class="state-box">
      <div class="icon">â³</div>
      <p>Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Wildberries...</p>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• Ğ’ĞšĞ›ĞĞ”ĞšĞ ĞĞĞ¡Ğ¢Ğ ĞĞ™ĞšĞ˜ â•â•â•â•â•â•â•â•â•â• -->
<div id="panel-settings" class="tab-panel">

  <!-- API Ozon -->
  <div class="section-card">
    <div class="section-title">ğŸ”‘ API-ĞºĞ»ÑÑ‡Ğ¸ Ozon <span id="ozon-status-badge"></span></div>
    <div class="hint-box">
      Ğ“Ğ´Ğµ Ğ²Ğ·ÑÑ‚ÑŒ: <strong>seller.ozon.ru</strong> â†’ ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ (âš™ï¸) â†’ API ĞºĞ»ÑÑ‡Ğ¸ â†’ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ ĞºĞ»ÑÑ‡ â†’ Ñ‚Ğ¸Ğ¿ <strong>Admin</strong><br>
      Ğ¡ĞºĞ¾Ğ¿Ğ¸Ñ€ÑƒĞ¹ <strong>Client-ID</strong> Ğ¸ <strong>API-key</strong>
    </div>
    <label class="form-label">Client-ID</label>
    <input id="ozon-client-id" class="form-input" type="text" placeholder="ĞĞ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: 123456" inputmode="numeric">
    <label class="form-label">API-ĞºĞ»ÑÑ‡</label>
    <input id="ozon-api-key" class="form-input" type="password" placeholder="Ğ’ÑÑ‚Ğ°Ğ²ÑŒÑ‚Ğµ API-ĞºĞ»ÑÑ‡ Ozon">
    <button class="save-btn" onclick="saveCredentials('ozon')">Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ ĞºĞ»ÑÑ‡Ğ¸ Ozon</button>
  </div>

  <!-- API WB -->
  <div class="section-card">
    <div class="section-title">ğŸ”‘ API-ĞºĞ»ÑÑ‡ Wildberries <span id="wb-status-badge"></span></div>
    <div class="hint-box">
      Ğ“Ğ´Ğµ Ğ²Ğ·ÑÑ‚ÑŒ: <strong>seller.wildberries.ru</strong> â†’ ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ (Ğ¸Ğ¼Ñ ÑĞ¿Ñ€Ğ°Ğ²Ğ° Ğ²Ğ²ĞµÑ€Ñ…Ñƒ) â†’ ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ â†’ Ğ”Ğ¾ÑÑ‚ÑƒĞ¿ Ğº API â†’ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ñ‚Ğ¾ĞºĞµĞ½<br>
      ĞŸĞ¾ÑÑ‚Ğ°Ğ²ÑŒ Ğ³Ğ°Ğ»Ğ¾Ñ‡ĞºĞ¸: âœ… Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° &nbsp;âœ… Ğ ĞµĞºĞ»Ğ°Ğ¼Ğ° &nbsp;âœ… ĞšĞ¾Ğ½Ñ‚ĞµĞ½Ñ‚
    </div>
    <label class="form-label">API-Ñ‚Ğ¾ĞºĞµĞ½</label>
    <input id="wb-api-key" class="form-input" type="password" placeholder="Ğ’ÑÑ‚Ğ°Ğ²ÑŒÑ‚Ğµ Ñ‚Ğ¾ĞºĞµĞ½ WB">
    <button class="save-btn" onclick="saveCredentials('wb')">Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ ĞºĞ»ÑÑ‡ WB</button>
  </div>

  <hr class="divider">

  <!-- KPI Ğ¿Ğ»Ğ°Ğ½Ñ‹ -->
  <div class="section-card">
    <div class="section-title">ğŸ¯ ĞŸĞ»Ğ°Ğ½Ñ‹ KPI Ğ½Ğ° Ğ¼ĞµÑÑÑ†</div>
    <div class="hint-box">
      Ğ£ĞºĞ°Ğ¶Ğ¸ Ñ†ĞµĞ»Ğ¸. Ğ‘Ğ¾Ñ‚ Ğ±ÑƒĞ´ĞµÑ‚ ÑÑ€Ğ°Ğ²Ğ½Ğ¸Ğ²Ğ°Ñ‚ÑŒ Ñ€ĞµĞ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ñ Ğ¿Ğ»Ğ°Ğ½Ğ°Ğ¼Ğ¸ Ğ¸ Ğ¿Ñ€Ğ¸ÑÑ‹Ğ»Ğ°Ñ‚ÑŒ Ğ°Ğ»ĞµÑ€Ñ‚Ñ‹ Ğ¿Ñ€Ğ¸ Ğ¾Ñ‚ĞºĞ»Ğ¾Ğ½ĞµĞ½Ğ¸ÑÑ….
    </div>

    <label class="form-label">ğŸ’° Ğ’Ñ‹Ñ€ÑƒÑ‡ĞºĞ°, â‚½</label>
    <input id="kpi-revenue" class="form-input" type="number" placeholder="ĞĞ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: 5000000" inputmode="numeric">

    <label class="form-label">ğŸ“¦ Ğ—Ğ°ĞºĞ°Ğ·Ñ‹ Ğ² Ğ´ĞµĞ½ÑŒ, ÑˆÑ‚ÑƒĞº</label>
    <input id="kpi-daily_orders" class="form-input" type="number" placeholder="ĞĞ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: 100" inputmode="numeric">

    <label class="form-label">ğŸ“¢ Ğ ĞµĞºĞ»Ğ°Ğ¼Ğ½Ñ‹Ğ¹ Ğ±ÑĞ´Ğ¶ĞµÑ‚, â‚½</label>
    <input id="kpi-ad_budget" class="form-input" type="number" placeholder="ĞĞ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: 100000" inputmode="numeric">

    <label class="form-label">ğŸ”„ Ğ¦ĞµĞ»ĞµĞ²Ğ°Ñ ĞºĞ¾Ğ½Ğ²ĞµÑ€ÑĞ¸Ñ, %</label>
    <input id="kpi-conversion" class="form-input" type="number" step="0.1" placeholder="ĞĞ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: 3.5" inputmode="decimal">

    <button class="save-btn" onclick="saveAllKpi()">Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ Ğ¿Ğ»Ğ°Ğ½Ñ‹</button>
  </div>

</div><!-- /panel-settings -->

<script>
// â”€â”€ Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Telegram WebApp â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function bootstrapTelegramWebApp() {
  const tg = window.Telegram && window.Telegram.WebApp;
  if (!tg) return;
  try {
    tg.ready();
    tg.expand();
    tg.setBackgroundColor("#05060e");
    tg.setHeaderColor("#05060e");
  } catch (error) {
    // ĞĞµĞºĞ¾Ñ‚Ğ¾Ñ€Ñ‹Ğµ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ñ‹ Telegram Ğ¸Ğ³Ğ½Ğ¾Ñ€Ğ¸Ñ€ÑƒÑÑ‚ ÑÑ‚Ğ¸ Ğ¼ĞµÑ‚Ğ¾Ğ´Ñ‹
  }
})();

// â”€â”€ ĞšÑÑˆ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… (Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ½Ğµ Ğ¿ĞµÑ€ĞµĞ³Ñ€ÑƒĞ¶Ğ°Ñ‚ÑŒ API Ğ¿Ñ€Ğ¸ Ğ¿ĞµÑ€ĞµĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğ¸) â”€â”€â”€â”€
const dataCache = {};
let currentTab  = 'ozon';

// â”€â”€ ĞŸĞµÑ€ĞµĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Ğ²ĞºĞ»Ğ°Ğ´Ğ¾Ğº â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(name) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  document.querySelector(`.tab-btn[onclick="switchTab('${name}')"]`).classList.add('active');
  document.getElementById(`panel-${name}`).classList.add('active');
  currentTab = name;

  if (name === 'ozon')     loadPlatformData('ozon');
  if (name === 'wb')       loadPlatformData('wb');
  if (name === 'settings') loadSettingsPage();
}

// â”€â”€ Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… Ğ¿Ğ»Ğ°Ñ‚Ñ„Ğ¾Ñ€Ğ¼Ñ‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadPlatformData(platform, forceRefresh = false) {
  const el = document.getElementById(`${platform}-content`);

  if (dataCache[platform] && !forceRefresh) {
    el.innerHTML = dataCache[platform];
    return;
  }

  el.innerHTML = `
    <div class="state-box">
      <div class="icon">â³</div>
      <p>Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ ${platform === 'ozon' ? 'Ozon' : 'Wildberries'}...</p>
    </div>`;

  try {
    const res  = await fetch(`/api/data/${platform}`);
    const data = await res.json();

    if (!res.ok || data.error) {
      el.innerHTML = `
        <div class="state-box">
          <div class="icon">ğŸ”‘</div>
          <p>${data.error || 'ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸'}</p>
          <small>ĞŸĞµÑ€ĞµĞ¹Ğ´Ğ¸Ñ‚Ğµ Ğ² âš™ï¸ ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Ğ¸ Ğ²Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ API-ĞºĞ»ÑÑ‡Ğ¸</small>
        </div>`;
      return;
    }

    const html = buildDashboard(data, platform);
    dataCache[platform] = html;
    el.innerHTML = html;
  } catch (e) {
    el.innerHTML = `
      <div class="state-box">
        <div class="icon">âŒ</div>
        <p>ĞĞµÑ‚ ÑĞ²ÑĞ·Ğ¸ Ñ ÑĞµÑ€Ğ²ĞµÑ€Ğ¾Ğ¼</p>
        <small>${e.message}</small>
      </div>`;
  }
}

// â”€â”€ ĞŸĞ¾ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ¸Ğµ Ğ´Ğ°ÑˆĞ±Ğ¾Ñ€Ğ´Ğ° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildDashboard({ today, month, kpi, error }, platform) {
  const t = today || {};
  const m = month || {};
  const k = kpi   || {};

  const isOzon = platform === 'ozon';
  const name   = isOzon ? 'Ozon' : 'Wildberries';
  const now    = new Date().toLocaleTimeString('ru', { hour: '2-digit', minute: '2-digit' });

  // Ğ”Ğ½ĞµĞ²Ğ½Ñ‹Ğµ Ñ†ĞµĞ»Ğ¸ (Ğ¼ĞµÑÑÑ‡Ğ½Ñ‹Ğ¹ Ğ¿Ğ»Ğ°Ğ½ / 30)
  const dayRevTarget  = k.revenue    ? k.revenue    / 30 : 0;
  const dayOrdTarget  = k.daily_orders || 0;
  const adBudget      = k.ad_budget  || 0;
  const convTarget    = k.conversion || 0;

  function fmtMoney(n) {
    n = n || 0;
    if (n >= 1000000) return (n/1000000).toFixed(1) + 'Ğœ â‚½';
    if (n >= 1000)    return Math.round(n/1000) + 'Ğš â‚½';
    return n.toLocaleString('ru') + ' â‚½';
  }

  function fmtNum(n) { return (n || 0).toLocaleString('ru'); }
  function pct(val, max) { return max ? Math.min((val / max) * 100, 100).toFixed(0) : 0; }

  function deltaHtml(val, plan, higherIsBetter = true) {
    if (!plan || !val) return '<span style="color:var(--text-soft);font-size:11px">â€” Ğ½ĞµÑ‚ Ğ¿Ğ»Ğ°Ğ½Ğ°</span>';
    const d   = ((val / plan - 1) * 100).toFixed(1);
    const ok  = higherIsBetter ? val >= plan : val <= plan;
    const cls = ok ? 'delta-up' : 'delta-down';
    const arrow = ok ? 'â–²' : 'â–¼';
    return `<div class="kpi-delta ${cls}">${arrow} ${Math.abs(d)}% Ğº Ğ¿Ğ»Ğ°Ğ½Ñƒ</div>`;
  }

  function barHtml(val, max, isWarn = false) {
    const p = pct(val, max);
    return `
      <div class="bar-track">
        <div class="bar-fill ${isWarn ? 'warn' : ''}" style="width:${p}%"></div>
      </div>`;
  }

  // ĞĞ»ĞµÑ€Ñ‚Ñ‹
  let alerts = '';
  if (adBudget && t.adSpend > adBudget * 0.85) {
    alerts += `
      <div class="alert-card">
        <div class="alert-title">ğŸ’¸ Ğ ĞµĞºĞ»Ğ°Ğ¼Ğ½Ñ‹Ğ¹ Ğ±ÑĞ´Ğ¶ĞµÑ‚ Ğ½Ğ° Ğ¸ÑÑ…Ğ¾Ğ´Ğµ</div>
        ĞŸĞ¾Ñ‚Ñ€Ğ°Ñ‡ĞµĞ½Ğ¾ ${fmtMoney(t.adSpend)} Ğ¸Ğ· ${fmtMoney(adBudget)} (${pct(t.adSpend, adBudget)}%)
      </div>`;
  }
  if (convTarget && t.conversion && t.conversion < convTarget * 0.7) {
    alerts += `
      <div class="alert-card">
        <div class="alert-title">ğŸ“‰ ĞĞ¸Ğ·ĞºĞ°Ñ ĞºĞ¾Ğ½Ğ²ĞµÑ€ÑĞ¸Ñ</div>
        Ğ¡ĞµĞ¹Ñ‡Ğ°Ñ ${t.conversion}% Ğ¿Ñ€Ğ¸ Ñ†ĞµĞ»Ğ¸ ${convTarget}%. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑŒÑ‚Ğµ ĞºĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºĞ¸ Ñ‚Ğ¾Ğ²Ğ°Ñ€Ğ¾Ğ².
      </div>`;
  }
  if (error) {
    alerts += `
      <div class="alert-card">
        <div class="alert-title">âš ï¸ Ğ§Ğ°ÑÑ‚Ğ¸Ñ‡Ğ½Ğ°Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ° API</div>
        ${error}
      </div>`;
  }

  return `
    <div class="platform-header">
      <div class="platform-dot ${platform}"></div>
      <div class="platform-name">${name}</div>
      <div class="platform-updated">Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾ Ğ² ${now}</div>
      <button class="refresh-btn" onclick="refreshData('${platform}')">ğŸ”„</button>
    </div>

    ${alerts}

    <div class="section-title">Ğ¡ĞµĞ³Ğ¾Ğ´Ğ½Ñ</div>
    <div class="kpi-grid">
      <div class="kpi-card">
        <div class="kpi-label">ğŸ’° Ğ’Ñ‹Ñ€ÑƒÑ‡ĞºĞ°</div>
        <div class="kpi-value" style="color:var(--mint)">${fmtMoney(t.revenue)}</div>
        ${deltaHtml(t.revenue, dayRevTarget)}
      </div>
      <div class="kpi-card">
        <div class="kpi-label">ğŸ“¦ Ğ—Ğ°ĞºĞ°Ğ·Ñ‹</div>
        <div class="kpi-value">${fmtNum(t.orders)}</div>
        ${deltaHtml(t.orders, dayOrdTarget)}
      </div>
      <div class="kpi-card">
        <div class="kpi-label">ğŸ“¢ Ğ ĞµĞºĞ»Ğ°Ğ¼Ğ°</div>
        <div class="kpi-value" style="color:${t.adSpend > adBudget * 0.85 ? 'var(--orange)' : 'var(--yellow)'}">
          ${fmtMoney(t.adSpend)}
        </div>
        ${deltaHtml(t.adSpend, adBudget, false)}
      </div>
      <div class="kpi-card">
        <div class="kpi-label">ğŸ”„ ĞšĞ¾Ğ½Ğ²ĞµÑ€ÑĞ¸Ñ</div>
        <div class="kpi-value">${(t.conversion || 0).toFixed(1)}%</div>
        ${deltaHtml(t.conversion, convTarget)}
      </div>
    </div>

    <div class="section-title">Ğ—Ğ° Ğ¼ĞµÑÑÑ†</div>

    <div class="bar-card">
      <div class="bar-header">
        <span>Ğ’Ñ‹Ñ€ÑƒÑ‡ĞºĞ°</span>
        <strong>${fmtMoney(m.revenue)} / ${fmtMoney(k.revenue)}</strong>
      </div>
      ${barHtml(m.revenue, k.revenue)}
    </div>

    <div class="bar-card">
      <div class="bar-header">
        <span>Ğ—Ğ°ĞºĞ°Ğ·Ñ‹</span>
        <strong>${fmtNum(m.orders)} / ${fmtNum(k.daily_orders * 30)}</strong>
      </div>
      ${barHtml(m.orders, k.daily_orders * 30)}
    </div>

    <div class="bar-card">
      <div class="bar-header">
        <span>Ğ ĞµĞºĞ»Ğ°Ğ¼Ğ½Ñ‹Ğ¹ Ğ±ÑĞ´Ğ¶ĞµÑ‚</span>
        <strong>${fmtMoney(t.adSpend)} / ${fmtMoney(k.ad_budget)}</strong>
      </div>
      ${barHtml(t.adSpend, k.ad_budget, t.adSpend > k.ad_budget * 0.7)}
    </div>
  `;
}

// â”€â”€ ĞĞ±Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ (ÑĞ±Ñ€Ğ¾ÑĞ¸Ñ‚ÑŒ ĞºÑÑˆ) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function refreshData(platform) {
  delete dataCache[platform];
  loadPlatformData(platform, true);
}

// â”€â”€ Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ API-ĞºĞ»ÑÑ‡Ğ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function saveCredentials(platform) {
  const apiKey   = document.getElementById(`${platform}-api-key`).value.trim();
  const clientId = platform === 'ozon'
    ? (document.getElementById('ozon-client-id').value.trim())
    : '';

  if (!apiKey) { alert('Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ API-ĞºĞ»ÑÑ‡'); return; }
  if (platform === 'ozon' && !clientId) { alert('Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Client-ID Ğ´Ğ»Ñ Ozon'); return; }

  const btn = event.currentTarget;
  btn.disabled = true;
  btn.textContent = 'Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑÑ...';

  try {
    const res  = await fetch('/api/credentials', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ platform, apiKey, clientId }),
    });
    const data = await res.json();

    if (data.ok) {
      document.getElementById(`${platform}-api-key`).value = '';
      if (platform === 'ozon') document.getElementById('ozon-client-id').value = '';
      delete dataCache[platform];
      loadStatusBadges();
      alert(`âœ… ĞšĞ»ÑÑ‡Ğ¸ ${platform === 'ozon' ? 'Ozon' : 'WB'} ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ñ‹!\n\nĞ¢ĞµĞ¿ĞµÑ€ÑŒ Ğ¿ĞµÑ€ĞµĞ¹Ğ´Ğ¸Ñ‚Ğµ Ğ½Ğ° Ğ²ĞºĞ»Ğ°Ğ´ĞºÑƒ ${platform === 'ozon' ? 'ğŸ”µ Ozon' : 'ğŸŸ£ WB'} Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ….`);
    } else {
      alert('âŒ ' + (data.error || 'ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ'));
    }
  } catch (e) {
    alert('âŒ ĞÑˆĞ¸Ğ±ĞºĞ°: ' + e.message);
  } finally {
    btn.disabled = false;
    btn.textContent = `Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ ĞºĞ»ÑÑ‡Ğ¸ ${platform === 'ozon' ? 'Ozon' : 'WB'}`;
  }
}

// â”€â”€ Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ Ğ²ÑĞµ KPI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function saveAllKpi() {
  const fields = [
    { key: 'revenue',      id: 'kpi-revenue' },
    { key: 'daily_orders', id: 'kpi-daily_orders' },
    { key: 'ad_budget',    id: 'kpi-ad_budget' },
    { key: 'conversion',   id: 'kpi-conversion' },
  ];

  let saved = 0;
  for (const f of fields) {
    const val = document.getElementById(f.id).value.trim();
    if (val === '') continue;
    await fetch('/api/kpi', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ key: f.key, value: parseFloat(val) }),
    });
    saved++;
  }

  // Ğ¡Ğ±Ñ€Ğ°ÑÑ‹Ğ²Ğ°ĞµĞ¼ ĞºÑÑˆ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… â€” Ğ¿Ğ»Ğ°Ğ½Ñ‹ Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ğ»Ğ¸ÑÑŒ
  dataCache['ozon'] = null;
  dataCache['wb']   = null;

  alert(saved ? `âœ… Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¾ Ğ¿Ğ»Ğ°Ğ½Ğ¾Ğ²: ${saved}` : 'Ğ—Ğ°Ğ¿Ğ¾Ğ»Ğ½Ğ¸ Ñ…Ğ¾Ñ‚Ñ Ğ±Ñ‹ Ğ¾Ğ´Ğ½Ğ¾ Ğ¿Ğ¾Ğ»Ğµ');
}

// â”€â”€ Ğ—Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ ÑÑ‚Ñ€Ğ°Ğ½Ğ¸Ñ†Ñƒ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞº â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadSettingsPage() {
  loadStatusBadges();

  try {
    const res = await fetch('/api/kpi');
    const kpi = await res.json();

    const map = {
      revenue:      'kpi-revenue',
      daily_orders: 'kpi-daily_orders',
      ad_budget:    'kpi-ad_budget',
      conversion:   'kpi-conversion',
    };
    for (const [key, id] of Object.entries(map)) {
      if (kpi[key] !== undefined) {
        document.getElementById(id).value = kpi[key];
      }
    }
  } catch(e) {}
}

// â”€â”€ Ğ‘ĞµĞ¹Ğ´Ğ¶Ğ¸ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ° ĞºĞ»ÑÑ‡ĞµĞ¹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadStatusBadges() {
  try {
    const res  = await fetch('/api/credentials/status');
    const data = await res.json();

    document.getElementById('ozon-status-badge').innerHTML = data.ozon
      ? '<span class="badge-ok">âœ“ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡Ñ‘Ğ½</span>'
      : '<span class="badge-no">Ğ½Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½</span>';

    document.getElementById('wb-status-badge').innerHTML = data.wb
      ? '<span class="badge-ok">âœ“ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡Ñ‘Ğ½</span>'
      : '<span class="badge-no">Ğ½Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½</span>';
  } catch(e) {}
}

// â”€â”€ Ğ¡Ñ‚Ğ°Ñ€Ñ‚: Ğ·Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°ĞµĞ¼ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¿ĞµÑ€Ğ²Ğ¾Ğ¹ Ğ²ĞºĞ»Ğ°Ğ´ĞºĞ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
loadPlatformData('ozon');
</script>
</body>
</html>