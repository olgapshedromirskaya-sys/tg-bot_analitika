<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ĞĞ½Ğ°Ğ»Ğ¸Ñ‚Ğ¸ĞºĞ° Ğ¼Ğ°Ñ€ĞºĞµÑ‚Ğ¿Ğ»ĞµĞ¹ÑĞ¾Ğ²</title>
<link rel="stylesheet" href="assets/styles.css">
<style>
  /* â”€â”€ Ğ’ĞºĞ»Ğ°Ğ´ĞºĞ¸ â”€â”€ */
  .tabs {
    display: flex;
    position: sticky;
    top: 0;
    z-index: 200;
    background: var(--bg-card);
    border-bottom: 1px solid var(--line);
  }
  .tab-btn {
    flex: 1;
    padding: 13px 4px;
    font-size: 12px;
    font-weight: 700;
    font-family: inherit;
    color: var(--text-soft);
    background: none;
    border: none;
    border-bottom: 2px solid transparent;
    cursor: pointer;
    transition: all 0.2s;
  }
  .tab-btn.active {
    color: var(--cyan);
    border-bottom-color: var(--cyan);
    background: rgba(89,156,255,0.05);
  }
  .tab-panel { display: none; padding: 14px; }
  .tab-panel.active { display: block; }

  /* â”€â”€ ĞšĞ°Ñ€Ñ‚Ğ¾Ñ‡ĞºĞ¸ Ğ¼ĞµÑ‚Ñ€Ğ¸Ğº â”€â”€ */
  .kpi-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    margin-bottom: 12px;
  }
  .kpi-card {
    background: var(--bg-card-strong, #151929);
    border: 1px solid var(--line);
    border-radius: 14px;
    padding: 12px;
  }
  .kpi-label { font-size: 11px; color: var(--text-soft); margin-bottom: 5px; }
  .kpi-value { font-size: 20px; font-weight: 800; line-height: 1; margin-bottom: 4px; }
  .kpi-delta { font-size: 11px; font-weight: 600; }
  .delta-up   { color: var(--green, #4caf50); }
  .delta-down { color: var(--orange, #ff8b57); }

  /* â”€â”€ ĞŸÑ€Ğ¾Ğ³Ñ€ĞµÑÑ-Ğ±Ğ°Ñ€Ñ‹ â”€â”€ */
  .bar-card {
    background: var(--bg-card-strong, #151929);
    border: 1px solid var(--line);
    border-radius: 12px;
    padding: 11px 13px;
    margin-bottom: 7px;
  }
  .bar-header {
    display: flex;
    justify-content: space-between;
    font-size: 11px;
    color: var(--text-soft);
    margin-bottom: 7px;
  }
  .bar-header strong { color: var(--text-main); }
  .bar-track { height: 5px; background: var(--line); border-radius: 5px; overflow: hidden; }
  .bar-fill {
    height: 100%;
    border-radius: 5px;
    background: linear-gradient(90deg, var(--cyan, #599cff), var(--mint, #66cec3));
    transition: width 0.8s ease;
  }
  .bar-fill.warn { background: linear-gradient(90deg, #f5c518, #ff8b57); }

  /* â”€â”€ Ğ¡ĞµĞºÑ†Ğ¸Ğ¸ â”€â”€ */
  .section-title {
    font-size: 10px;
    font-weight: 700;
    color: var(--text-soft);
    letter-spacing: 0.1em;
    text-transform: uppercase;
    margin: 16px 0 8px;
  }

  /* â”€â”€ Ğ¢Ğ¾Ğ²Ğ°Ñ€Ñ‹ Ğ² Ğ·Ğ¾Ğ½Ğµ Ñ€Ğ¸ÑĞºĞ° â”€â”€ */
  .risk-item {
    background: rgba(255,87,87,0.08);
    border: 1px solid rgba(255,87,87,0.25);
    border-radius: 12px;
    padding: 11px 13px;
    margin-bottom: 7px;
    display: flex;
    align-items: flex-start;
    gap: 10px;
  }
  .risk-icon { font-size: 18px; flex-shrink: 0; margin-top: 1px; }
  .risk-name { font-size: 13px; font-weight: 700; color: #ff6b6b; margin-bottom: 3px; }
  .risk-reason { font-size: 12px; color: var(--text-soft); line-height: 1.4; }
  .risk-sku { font-size: 10px; color: var(--text-soft); opacity: 0.6; margin-top: 2px; }

  /* â”€â”€ Ğ¢Ğ¾Ğ²Ğ°Ñ€Ñ‹ Ñ Ñ€Ğ¾ÑÑ‚Ğ¾Ğ¼ â”€â”€ */
  .growth-item {
    background: rgba(76,175,80,0.08);
    border: 1px solid rgba(76,175,80,0.25);
    border-radius: 12px;
    padding: 11px 13px;
    margin-bottom: 7px;
    display: flex;
    align-items: flex-start;
    gap: 10px;
  }
  .growth-icon { font-size: 18px; flex-shrink: 0; margin-top: 1px; }
  .growth-name { font-size: 13px; font-weight: 700; color: #4caf50; margin-bottom: 3px; }
  .growth-reason { font-size: 12px; color: var(--text-soft); line-height: 1.4; }

  /* â”€â”€ ĞÑÑ‚Ğ°Ñ‚ĞºĞ¸ â”€â”€ */
  .stock-item {
    background: var(--bg-card-strong, #151929);
    border: 1px solid var(--line);
    border-radius: 12px;
    padding: 11px 13px;
    margin-bottom: 7px;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .stock-indicator {
    width: 10px; height: 10px;
    border-radius: 50%;
    flex-shrink: 0;
  }
  .stock-indicator.critical { background: #ff4444; box-shadow: 0 0 6px #ff4444; }
  .stock-indicator.warning  { background: #f5c518; box-shadow: 0 0 6px #f5c518; }
  .stock-indicator.ok       { background: #4caf50; box-shadow: 0 0 6px #4caf50; }
  .stock-info { flex: 1; min-width: 0; }
  .stock-name { font-size: 13px; font-weight: 700; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .stock-meta { font-size: 11px; color: var(--text-soft); }
  .stock-qty  { font-size: 16px; font-weight: 800; color: var(--text-main); flex-shrink: 0; }

  /* â”€â”€ ĞšÑ€ÑƒĞ³Ğ¾Ğ²Ğ°Ñ Ğ´Ğ¸Ğ°Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ° â”€â”€ */
  .pie-wrap {
    background: var(--bg-card-strong, #151929);
    border: 1px solid var(--line);
    border-radius: 16px;
    padding: 16px;
    margin-bottom: 12px;
  }
  .pie-container {
    display: flex;
    align-items: center;
    gap: 16px;
  }
  .pie-svg-wrap { flex-shrink: 0; }
  .pie-legend { flex: 1; }
  .pie-legend-item {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
    font-size: 12px;
  }
  .pie-legend-dot {
    width: 10px; height: 10px;
    border-radius: 3px;
    flex-shrink: 0;
  }
  .pie-legend-name { color: var(--text-main); flex: 1; }
  .pie-legend-pct  { color: var(--text-soft); font-weight: 700; }
  .pie-legend-qty  { color: var(--text-soft); font-size: 11px; }

  /* â”€â”€ ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ â”€â”€ */
  .section-card {
    background: var(--bg-card);
    border: 1px solid var(--line);
    border-radius: 16px;
    padding: 14px;
    margin-bottom: 12px;
  }
  .section-heading {
    font-size: 11px;
    font-weight: 700;
    color: var(--text-soft);
    letter-spacing: 0.1em;
    text-transform: uppercase;
    margin-bottom: 10px;
  }
  .hint-box {
    background: rgba(89,156,255,0.08);
    border-radius: 10px;
    padding: 10px 12px;
    font-size: 12px;
    color: var(--text-soft);
    line-height: 1.6;
    margin-bottom: 12px;
  }
  .form-label { display: block; font-size: 12px; color: var(--text-soft); margin-bottom: 5px; }
  .form-input {
    width: 100%;
    background: var(--bg-card-strong, #151929);
    border: 1px solid var(--line);
    border-radius: 10px;
    padding: 11px 13px;
    color: var(--text-main);
    font-size: 14px;
    font-family: inherit;
    outline: none;
    margin-bottom: 9px;
    box-sizing: border-box;
    -webkit-appearance: none;
    transition: border-color 0.2s;
  }
  .form-input:focus { border-color: var(--cyan, #599cff); }
  .form-input::placeholder { color: var(--text-soft); opacity: 0.55; }
  .save-btn {
    width: 100%;
    padding: 12px;
    background: linear-gradient(135deg, var(--cyan, #599cff), var(--mint, #66cec3));
    border: none;
    border-radius: 12px;
    color: #07111f;
    font-weight: 800;
    font-size: 14px;
    font-family: inherit;
    cursor: pointer;
    box-sizing: border-box;
    transition: opacity 0.2s;
  }
  .save-btn:active { opacity: 0.8; }
  .save-btn:disabled { opacity: 0.5; cursor: default; }
  .badge-ok {
    display: inline-block;
    background: rgba(102,206,195,0.2);
    color: var(--mint, #66cec3);
    border-radius: 20px;
    padding: 1px 8px;
    font-size: 11px;
    font-weight: 700;
    margin-left: 6px;
  }
  .badge-no {
    display: inline-block;
    background: rgba(255,139,87,0.15);
    color: var(--orange, #ff8b57);
    border-radius: 20px;
    padding: 1px 8px;
    font-size: 11px;
    font-weight: 700;
    margin-left: 6px;
  }
  .s-divider { border: none; border-top: 1px solid var(--line); margin: 14px 0; }

  /* â”€â”€ Ğ¡Ğ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ â”€â”€ */
  .state-box { text-align: center; padding: 40px 16px; color: var(--text-soft); }
  .state-icon { font-size: 36px; margin-bottom: 10px; }
  .state-box p { font-size: 14px; line-height: 1.5; margin: 0 0 6px; }
  .state-box small { font-size: 12px; opacity: 0.65; }

  .platform-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 14px;
    padding-bottom: 10px;
    border-bottom: 1px solid var(--line);
  }
  .platform-dot { width: 9px; height: 9px; border-radius: 50%; }
  .platform-dot.ozon { background: #5b9fff; }
  .platform-dot.wb   { background: #cb11ab; }
  .platform-name { font-weight: 700; font-size: 14px; }
  .platform-updated { font-size: 11px; color: var(--text-soft); margin-left: auto; }
  .refresh-btn {
    background: none;
    border: 1px solid var(--line);
    border-radius: 8px;
    color: var(--text-soft);
    font-size: 12px;
    padding: 4px 10px;
    cursor: pointer;
    font-family: inherit;
  }

  /* â”€â”€ Ğ˜ÑÑ‚Ğ¾Ñ‡Ğ½Ğ¸Ğº Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… â”€â”€ */
  .source-badge {
    display: inline-block;
    font-size: 10px;
    padding: 2px 8px;
    border-radius: 20px;
    margin-left: 6px;
    font-weight: 600;
  }
  .source-api  { background: rgba(76,175,80,0.15); color: #4caf50; }
  .source-mock { background: rgba(245,197,24,0.15); color: #f5c518; }
</style>
</head>
<body>

<div class="tabs">
  <button class="tab-btn active" onclick="switchTab('ozon')">ğŸ”µ Ozon</button>
  <button class="tab-btn" onclick="switchTab('wb')">ğŸŸ£ WB</button>
  <button class="tab-btn" onclick="switchTab('settings')">âš™ï¸ ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸</button>
</div>

<!-- OZON -->
<div id="panel-ozon" class="tab-panel active">
  <div id="ozon-content">
    <div class="state-box"><div class="state-icon">â³</div><p>Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Ozon...</p></div>
  </div>
</div>

<!-- WB -->
<div id="panel-wb" class="tab-panel">
  <div id="wb-content">
    <div class="state-box"><div class="state-icon">â³</div><p>Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ Wildberries...</p></div>
  </div>
</div>

<!-- ĞĞĞ¡Ğ¢Ğ ĞĞ™ĞšĞ˜ -->
<div id="panel-settings" class="tab-panel">
  <div class="section-card">
    <div class="section-heading">ğŸ”‘ API-ĞºĞ»ÑÑ‡Ğ¸ Ozon <span id="ozon-status-badge"></span></div>
    <div class="hint-box">
      seller.ozon.ru â†’ ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ âš™ï¸ â†’ API ĞºĞ»ÑÑ‡Ğ¸ â†’ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ ĞºĞ»ÑÑ‡ â†’ Ñ‚Ğ¸Ğ¿ <strong>Admin</strong><br>
      ĞÑƒĞ¶Ğ½Ñ‹: <strong>Client-ID</strong> Ğ¸ <strong>API-ĞºĞ»ÑÑ‡</strong>
    </div>
    <label class="form-label">Client-ID</label>
    <input id="ozon-client-id" class="form-input" type="text" placeholder="ĞĞ°Ğ¿Ñ€Ğ¸Ğ¼ĞµÑ€: 123456" inputmode="numeric">
    <label class="form-label">API-ĞºĞ»ÑÑ‡</label>
    <input id="ozon-api-key" class="form-input" type="password" placeholder="Ğ’ÑÑ‚Ğ°Ğ²ÑŒÑ‚Ğµ API-ĞºĞ»ÑÑ‡ Ozon">
    <button class="save-btn" onclick="saveCredentials('ozon')">Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ ĞºĞ»ÑÑ‡Ğ¸ Ozon</button>
  </div>

  <div class="section-card">
    <div class="section-heading">ğŸ”‘ API-ĞºĞ»ÑÑ‡ Wildberries <span id="wb-status-badge"></span></div>
    <div class="hint-box">
      seller.wildberries.ru â†’ ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ â†’ ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ â†’ Ğ”Ğ¾ÑÑ‚ÑƒĞ¿ Ğº API â†’ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ñ‚Ğ¾ĞºĞµĞ½<br>
      Ğ“Ğ°Ğ»Ğ¾Ñ‡ĞºĞ¸: âœ… Ğ¡Ñ‚Ğ°Ñ‚Ğ¸ÑÑ‚Ğ¸ĞºĞ° &nbsp;âœ… Ğ ĞµĞºĞ»Ğ°Ğ¼Ğ° &nbsp;âœ… ĞĞ½Ğ°Ğ»Ğ¸Ñ‚Ğ¸ĞºĞ°
    </div>
    <label class="form-label">API-Ñ‚Ğ¾ĞºĞµĞ½</label>
    <input id="wb-api-key" class="form-input" type="password" placeholder="Ğ’ÑÑ‚Ğ°Ğ²ÑŒÑ‚Ğµ Ñ‚Ğ¾ĞºĞµĞ½ WB">
    <button class="save-btn" onclick="saveCredentials('wb')">Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ ĞºĞ»ÑÑ‡ WB</button>
  </div>

  <hr class="s-divider">

  <div class="section-card">
    <div class="section-heading">ğŸ¯ ĞŸĞ»Ğ°Ğ½Ñ‹ KPI Ğ½Ğ° Ğ¼ĞµÑÑÑ†</div>
    <div class="hint-box">Ğ£ĞºĞ°Ğ¶Ğ¸ Ñ†ĞµĞ»Ğ¸ â€” Ğ±Ğ¾Ñ‚ ÑÑ€Ğ°Ğ²Ğ½Ğ¸Ğ²Ğ°ĞµÑ‚ Ñ Ñ€ĞµĞ°Ğ»ÑŒĞ½Ñ‹Ğ¼Ğ¸ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğ¼Ğ¸ Ğ¸ Ğ¿Ñ€Ğ¸ÑÑ‹Ğ»Ğ°ĞµÑ‚ Ğ°Ğ»ĞµÑ€Ñ‚Ñ‹.</div>
    <label class="form-label">ğŸ’° Ğ’Ñ‹Ñ€ÑƒÑ‡ĞºĞ° Ğ·Ğ° Ğ¼ĞµÑÑÑ†, â‚½</label>
    <input id="kpi-revenue" class="form-input" type="number" placeholder="5000000" inputmode="numeric">
    <label class="form-label">ğŸ“¦ Ğ—Ğ°ĞºĞ°Ğ·Ğ¾Ğ² Ğ² Ğ´ĞµĞ½ÑŒ, ÑˆÑ‚ÑƒĞº</label>
    <input id="kpi-daily_orders" class="form-input" type="number" placeholder="100" inputmode="numeric">
    <label class="form-label">ğŸ“¢ Ğ ĞµĞºĞ»Ğ°Ğ¼Ğ½Ñ‹Ğ¹ Ğ±ÑĞ´Ğ¶ĞµÑ‚ Ğ² Ğ¼ĞµÑÑÑ†, â‚½</label>
    <input id="kpi-ad_budget" class="form-input" type="number" placeholder="100000" inputmode="numeric">
    <label class="form-label">ğŸ”„ Ğ¦ĞµĞ»ĞµĞ²Ğ°Ñ ĞºĞ¾Ğ½Ğ²ĞµÑ€ÑĞ¸Ñ, %</label>
    <input id="kpi-conversion" class="form-input" type="number" step="0.1" placeholder="3.5" inputmode="decimal">
    <button class="save-btn" onclick="saveAllKpi()">Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ Ğ¿Ğ»Ğ°Ğ½Ñ‹</button>
  </div>
</div>

<script>
// â”€â”€ Telegram WebApp â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
(function() {
  const tg = window.Telegram && window.Telegram.WebApp;
  if (!tg) return;
  try { tg.ready(); tg.expand(); tg.setBackgroundColor("#05060e"); tg.setHeaderColor("#05060e"); } catch(e) {}
})();

const dataCache = {};

// â”€â”€ Ğ¦Ğ²ĞµÑ‚Ğ° Ğ´Ğ»Ñ ĞºÑ€ÑƒĞ³Ğ¾Ğ²Ğ¾Ğ¹ Ğ´Ğ¸Ğ°Ğ³Ñ€Ğ°Ğ¼Ğ¼Ñ‹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const PIE_COLORS = [
  '#599cff','#66cec3','#f5c518','#ff8b57','#a78bfa',
  '#34d399','#f472b6','#60a5fa','#fbbf24','#4ade80'
];

// â”€â”€ ĞŸĞµÑ€ĞµĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ğµ Ğ²ĞºĞ»Ğ°Ğ´Ğ¾Ğº â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(name) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  document.querySelector(`.tab-btn[onclick="switchTab('${name}')"]`).classList.add('active');
  document.getElementById(`panel-${name}`).classList.add('active');
  if (name === 'ozon')     loadPlatformData('ozon');
  if (name === 'wb')       loadPlatformData('wb');
  if (name === 'settings') loadSettingsPage();
}

// â”€â”€ Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ… â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadPlatformData(platform, forceRefresh) {
  const el = document.getElementById(`${platform}-content`);
  if (dataCache[platform] && !forceRefresh) { el.innerHTML = dataCache[platform]; return; }

  el.innerHTML = `<div class="state-box"><div class="state-icon">â³</div><p>Ğ—Ğ°Ğ³Ñ€ÑƒĞ¶Ğ°Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ ${platform === 'ozon' ? 'Ozon' : 'Wildberries'}...</p></div>`;

  try {
    const res  = await fetch(`/api/data/${platform}`);
    const data = await res.json();

    if (!res.ok || data.error) {
      el.innerHTML = `<div class="state-box"><div class="state-icon">ğŸ”‘</div><p>${data.error || 'ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸'}</p><small>ĞŸĞµÑ€ĞµĞ¹Ğ´Ğ¸Ñ‚Ğµ Ğ² âš™ï¸ ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Ğ¸ Ğ²Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ API-ĞºĞ»ÑÑ‡Ğ¸</small></div>`;
      return;
    }

    const html = buildDashboard(data, platform);
    dataCache[platform] = html;
    el.innerHTML = html;
  } catch(e) {
    el.innerHTML = `<div class="state-box"><div class="state-icon">âŒ</div><p>ĞĞµÑ‚ ÑĞ²ÑĞ·Ğ¸ Ñ ÑĞµÑ€Ğ²ĞµÑ€Ğ¾Ğ¼</p><small>${e.message}</small></div>`;
  }
}

function refreshData(platform) { delete dataCache[platform]; loadPlatformData(platform, true); }

// â”€â”€ ĞŸĞ¾ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ¸Ğµ Ğ´Ğ°ÑˆĞ±Ğ¾Ñ€Ğ´Ğ° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildDashboard({ today, month, kpi, source, warehouses, stocks, atRiskProducts }, platform) {
  const t = today || {};
  const m = month || {};
  const k = kpi   || {};
  const now = new Date().toLocaleTimeString('ru', { hour: '2-digit', minute: '2-digit' });
  const isOzon = platform === 'ozon';

  const dayRevTarget = k.revenue      ? k.revenue / 30 : 0;
  const dayOrdTarget = k.daily_orders || 0;
  const adBudget     = k.ad_budget    || 0;
  const convTarget   = k.conversion   || 0;

  function fmtMoney(n) {
    n = n || 0;
    if (n >= 1000000) return (n/1000000).toFixed(1) + 'Ğœ â‚½';
    if (n >= 1000)    return Math.round(n/1000) + 'Ğš â‚½';
    return n.toLocaleString('ru') + ' â‚½';
  }
  function fmtNum(n) { return (n || 0).toLocaleString('ru'); }
  function pct(val, max) { return max ? Math.min((val/max)*100, 100).toFixed(0) : 0; }
  function deltaHtml(val, plan, higher = true) {
    if (!plan || !val) return '<span style="color:var(--text-soft);font-size:11px">â€” Ğ½ĞµÑ‚ Ğ¿Ğ»Ğ°Ğ½Ğ°</span>';
    const d = ((val/plan-1)*100).toFixed(1);
    const ok = higher ? val >= plan : val <= plan;
    return `<div class="kpi-delta ${ok?'delta-up':'delta-down'}">${ok?'â–²':'â–¼'} ${Math.abs(d)}% Ğº Ğ¿Ğ»Ğ°Ğ½Ñƒ</div>`;
  }
  function barHtml(val, max, warn) {
    return `<div class="bar-track"><div class="bar-fill ${warn?'warn':''}" style="width:${pct(val,max)}%"></div></div>`;
  }

  const sourceBadge = source === 'api'
    ? '<span class="source-badge source-api">â— Ñ€ĞµĞ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ</span>'
    : '<span class="source-badge source-mock">â— Ğ´ĞµĞ¼Ğ¾</span>';

  // â”€â”€ Ğ¢Ğ¾Ğ²Ğ°Ñ€Ñ‹ Ğ² Ğ·Ğ¾Ğ½Ğµ Ñ€Ğ¸ÑĞºĞ° â”€â”€
  const riskItems = (atRiskProducts || []).filter(p => p.trend === 'down' || !p.trend);
  const growthItemsFromRisk = (atRiskProducts || []).filter(p => p.trend === 'up');
  let riskHtml = '';
  if (riskItems.length > 0) {
    riskHtml = `<div class="section-title">ğŸš¨ Ğ¢Ğ¾Ğ²Ğ°Ñ€Ñ‹ Ğ² Ğ·Ğ¾Ğ½Ğµ Ñ€Ğ¸ÑĞºĞ°</div>`;
    for (const p of riskItems) {
      const revenueArrow = (p.revenueDelta || 0) >= 0 ? 'â–²' : 'â–¼';
      const revenueColor = (p.revenueDelta || 0) >= 0 ? '#4caf50' : '#ff4444';
      const ordersArrow  = (p.ordersDelta  || 0) >= 0 ? 'â–²' : 'â–¼';
      const ordersColor  = (p.ordersDelta  || 0) >= 0 ? '#4caf50' : '#ff4444';
      const ctrArrow     = (p.ctrDelta     || 0) >= 0 ? 'â–²' : 'â–¼';
      const ctrColor     = (p.ctrDelta     || 0) >= 0 ? '#4caf50' : '#ff4444';
      riskHtml += `
        <div class="risk-item">
          <div class="risk-icon">ğŸš¨</div>
          <div style="flex:1">
            <div class="risk-name">${p.name}${p.sku ? ` <span style="font-size:10px;opacity:0.6;font-weight:400">${p.sku}</span>` : ''}</div>
            <div class="risk-reason">${p.reason}</div>
            ${(p.revenueDelta !== undefined || p.ordersDelta !== undefined || p.ctrDelta !== undefined) ? `
            <div style="display:flex;gap:10px;margin-top:6px;flex-wrap:wrap">
              ${p.revenueDelta !== undefined ? `<span style="font-size:11px;font-weight:700;color:${revenueColor}">${revenueArrow} Ğ’Ñ‹Ñ€ÑƒÑ‡ĞºĞ° ${Math.abs(p.revenueDelta)}%</span>` : ''}
              ${p.ordersDelta  !== undefined ? `<span style="font-size:11px;font-weight:700;color:${ordersColor}">${ordersArrow} Ğ—Ğ°ĞºĞ°Ğ·Ñ‹ ${Math.abs(p.ordersDelta)}%</span>` : ''}
              ${p.ctrDelta     !== undefined ? `<span style="font-size:11px;font-weight:700;color:${ctrColor}">${ctrArrow} CTR ${Math.abs(p.ctrDelta)}%</span>` : ''}
            </div>` : ''}
          </div>
        </div>`;
    }
  }

  // â”€â”€ Ğ¢Ğ¾Ğ²Ğ°Ñ€Ñ‹ Ñ Ñ€Ğ¾ÑÑ‚Ğ¾Ğ¼ â”€â”€
  const growthItems = growthItemsFromRisk.length > 0
    ? growthItemsFromRisk
    : (stocks || []).filter(s => s.daysCover > 20).slice(0, 3);
  let growthHtml = '';
  if (growthItems.length > 0) {
    growthHtml = `<div class="section-title">ğŸ“ˆ Ğ Ğ¾ÑÑ‚ Ğ¿Ñ€Ğ¾Ğ´Ğ°Ğ¶</div>`;
    for (const p of growthItems) {
      const revenueArrow = (p.revenueDelta || 0) >= 0 ? 'â–²' : 'â–¼';
      const ordersArrow  = (p.ordersDelta  || 0) >= 0 ? 'â–²' : 'â–¼';
      const ctrArrow     = (p.ctrDelta     || 0) >= 0 ? 'â–²' : 'â–¼';
      growthHtml += `
        <div class="growth-item">
          <div class="growth-icon">ğŸ“ˆ</div>
          <div style="flex:1">
            <div class="growth-name">${p.name}${p.sku ? ` <span style="font-size:10px;opacity:0.6;font-weight:400">${p.sku}</span>` : ''}</div>
            <div class="growth-reason">${p.reason || ('ĞÑÑ‚Ğ°Ñ‚Ğ¾Ğº: ' + fmtNum(p.qty) + ' ÑˆÑ‚ Â· ĞŸĞ¾ĞºÑ€Ñ‹Ñ‚Ğ¸Ğµ: ' + p.daysCover + ' Ğ´Ğ½')}</div>
            ${(p.revenueDelta !== undefined || p.ordersDelta !== undefined || p.ctrDelta !== undefined) ? `
            <div style="display:flex;gap:10px;margin-top:6px;flex-wrap:wrap">
              ${p.revenueDelta !== undefined ? `<span style="font-size:11px;font-weight:700;color:#4caf50">${revenueArrow} Ğ’Ñ‹Ñ€ÑƒÑ‡ĞºĞ° ${Math.abs(p.revenueDelta)}%</span>` : ''}
              ${p.ordersDelta  !== undefined ? `<span style="font-size:11px;font-weight:700;color:#4caf50">${ordersArrow} Ğ—Ğ°ĞºĞ°Ğ·Ñ‹ ${Math.abs(p.ordersDelta)}%</span>` : ''}
              ${p.ctrDelta     !== undefined ? `<span style="font-size:11px;font-weight:700;color:#4caf50">${ctrArrow} CTR ${Math.abs(p.ctrDelta)}%</span>` : ''}
            </div>` : ''}
          </div>
        </div>`;
    }
  }

  // â”€â”€ ĞÑÑ‚Ğ°Ñ‚ĞºĞ¸ Ğ½Ğ° ÑĞºĞ»Ğ°Ğ´Ğ°Ñ… â”€â”€
  let stocksHtml = '';
  if (stocks && stocks.length > 0) {
    stocksHtml = `<div class="section-title">ğŸ“¦ ĞÑÑ‚Ğ°Ñ‚ĞºĞ¸ Ğ½Ğ° ÑĞºĞ»Ğ°Ğ´Ğ°Ñ…</div>`;
    for (const s of stocks.slice(0, 10)) {
      const level = s.daysCover < 7 ? 'critical' : s.daysCover < 14 ? 'warning' : 'ok';
      const label = s.daysCover < 7 ? 'ğŸ”´ ĞºÑ€Ğ¸Ñ‚Ğ¸Ñ‡Ğ½Ğ¾' : s.daysCover < 14 ? 'ğŸŸ¡ ĞºĞ¾Ğ½Ñ‚Ñ€Ğ¾Ğ»ÑŒ' : 'ğŸŸ¢ ÑÑ‚Ğ°Ğ±Ğ¸Ğ»ÑŒĞ½Ğ¾';
      stocksHtml += `
        <div class="stock-item">
          <div class="stock-indicator ${level}"></div>
          <div class="stock-info">
            <div class="stock-name">${s.name}</div>
            <div class="stock-meta">${s.sku} Â· ${s.warehouseName || ''} Â· ${s.daysCover} Ğ´Ğ½ Â· ${label}</div>
          </div>
          <div class="stock-qty">${fmtNum(s.qty)}</div>
        </div>`;
    }
  }

  // â”€â”€ ĞšÑ€ÑƒĞ³Ğ¾Ğ²Ğ°Ñ Ğ´Ğ¸Ğ°Ğ³Ñ€Ğ°Ğ¼Ğ¼Ğ° ÑĞºĞ»Ğ°Ğ´Ğ¾Ğ² â”€â”€
  let pieHtml = '';
  if (warehouses && warehouses.length > 0) {
    const total = warehouses.reduce((s, w) => s + w.qty, 0);
    const top   = warehouses.slice(0, 8);

    // SVG Ğ¿Ğ¸Ñ€Ğ¾Ğ³
    const SIZE = 120, CX = 60, CY = 60, R = 50;
    let svgPaths = '';
    let startAngle = -Math.PI / 2;
    for (let i = 0; i < top.length; i++) {
      const slice = (top[i].qty / total) * 2 * Math.PI;
      const endAngle = startAngle + slice;
      const x1 = CX + R * Math.cos(startAngle);
      const y1 = CY + R * Math.sin(startAngle);
      const x2 = CX + R * Math.cos(endAngle);
      const y2 = CY + R * Math.sin(endAngle);
      const large = slice > Math.PI ? 1 : 0;
      const color = PIE_COLORS[i % PIE_COLORS.length];
      svgPaths += `<path d="M${CX},${CY} L${x1.toFixed(1)},${y1.toFixed(1)} A${R},${R} 0 ${large},1 ${x2.toFixed(1)},${y2.toFixed(1)} Z" fill="${color}" stroke="#0a0f1e" stroke-width="2"/>`;
      startAngle = endAngle;
    }

    // Ğ›ĞµĞ³ĞµĞ½Ğ´Ğ°
    let legendHtml = '';
    for (let i = 0; i < top.length; i++) {
      const p = ((top[i].qty / total) * 100).toFixed(0);
      legendHtml += `
        <div class="pie-legend-item">
          <div class="pie-legend-dot" style="background:${PIE_COLORS[i % PIE_COLORS.length]}"></div>
          <div class="pie-legend-name">${top[i].name}</div>
          <div class="pie-legend-pct">${p}%</div>
        </div>
        <div style="font-size:11px;color:var(--text-soft);margin:-4px 0 6px 18px">${fmtNum(top[i].qty)} ÑˆÑ‚</div>`;
    }

    pieHtml = `
      <div class="section-title">ğŸ—ºï¸ Ğ Ğ°ÑĞ¿Ñ€ĞµĞ´ĞµĞ»ĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾ ÑĞºĞ»Ğ°Ğ´Ğ°Ğ¼</div>
      <div class="pie-wrap">
        <div class="pie-container">
          <div class="pie-svg-wrap">
            <svg width="${SIZE}" height="${SIZE}" viewBox="0 0 ${SIZE} ${SIZE}">${svgPaths}</svg>
          </div>
          <div class="pie-legend">${legendHtml}</div>
        </div>
        <div style="font-size:11px;color:var(--text-soft);margin-top:10px;text-align:center">
          Ğ’ÑĞµĞ³Ğ¾ Ğ½Ğ° ÑĞºĞ»Ğ°Ğ´Ğ°Ñ…: <strong style="color:var(--text-main)">${fmtNum(total)} ÑˆÑ‚</strong>
        </div>
      </div>`;
  }

  return `
    <div class="platform-header">
      <div class="platform-dot ${platform}"></div>
      <div class="platform-name">${isOzon ? 'Ozon' : 'Wildberries'}${sourceBadge}</div>
      <div class="platform-updated">${now}</div>
      <button class="refresh-btn" onclick="refreshData('${platform}')">ğŸ”„</button>
    </div>

    <div class="section-title">Ğ¡ĞµĞ³Ğ¾Ğ´Ğ½Ñ</div>
    <div class="kpi-grid">
      <div class="kpi-card">
        <div class="kpi-label">ğŸ’° Ğ’Ñ‹Ñ€ÑƒÑ‡ĞºĞ°</div>
        <div class="kpi-value" style="color:var(--mint,#66cec3)">${fmtMoney(t.revenue)}</div>
        ${deltaHtml(t.revenue, dayRevTarget)}
      </div>
      <div class="kpi-card">
        <div class="kpi-label">ğŸ“¦ Ğ—Ğ°ĞºĞ°Ğ·Ñ‹</div>
        <div class="kpi-value">${fmtNum(t.orders)}</div>
        ${deltaHtml(t.orders, dayOrdTarget)}
      </div>
      <div class="kpi-card">
        <div class="kpi-label">ğŸ“¢ Ğ ĞµĞºĞ»Ğ°Ğ¼Ğ°</div>
        <div class="kpi-value" style="color:${t.adSpend > adBudget*0.85 ? 'var(--orange,#ff8b57)' : 'var(--yellow,#f5c518)'}">
          ${fmtMoney(t.adSpend)}
        </div>
        ${deltaHtml(t.adSpend, adBudget, false)}
      </div>
      <div class="kpi-card">
        <div class="kpi-label">ğŸ”„ ĞšĞ¾Ğ½Ğ²ĞµÑ€ÑĞ¸Ñ</div>
        <div class="kpi-value">${(t.conversion||0).toFixed(1)}%</div>
        ${deltaHtml(t.conversion, convTarget)}
      </div>
    </div>

    <div class="section-title">Ğ—Ğ° Ğ¼ĞµÑÑÑ†</div>
    <div class="bar-card">
      <div class="bar-header"><span>Ğ’Ñ‹Ñ€ÑƒÑ‡ĞºĞ°</span><strong>${fmtMoney(m.revenue)} / ${fmtMoney(k.revenue)}</strong></div>
      ${barHtml(m.revenue, k.revenue)}
    </div>
    <div class="bar-card">
      <div class="bar-header"><span>Ğ—Ğ°ĞºĞ°Ğ·Ñ‹</span><strong>${fmtNum(m.orders)} / ${fmtNum(k.daily_orders*30)}</strong></div>
      ${barHtml(m.orders, k.daily_orders*30)}
    </div>
    <div class="bar-card">
      <div class="bar-header"><span>Ğ ĞµĞºĞ»Ğ°Ğ¼Ğ½Ñ‹Ğ¹ Ğ±ÑĞ´Ğ¶ĞµÑ‚</span><strong>${fmtMoney(t.adSpend)} / ${fmtMoney(k.ad_budget)}</strong></div>
      ${barHtml(t.adSpend, k.ad_budget, t.adSpend > k.ad_budget*0.7)}
    </div>

    ${riskHtml}
    ${growthHtml}
    ${stocksHtml}
    ${pieHtml}
  `;
}

// â”€â”€ Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ API-ĞºĞ»ÑÑ‡Ğ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function saveCredentials(platform) {
  const apiKey   = document.getElementById(`${platform}-api-key`).value.trim();
  const clientId = platform === 'ozon' ? document.getElementById('ozon-client-id').value.trim() : '';
  if (!apiKey) { alert('Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ API-ĞºĞ»ÑÑ‡'); return; }
  if (platform === 'ozon' && !clientId) { alert('Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Client-ID Ğ´Ğ»Ñ Ozon'); return; }
  const btn = event.currentTarget;
  btn.disabled = true; btn.textContent = 'Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑÑ...';
  try {
    const res  = await fetch('/api/credentials', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({platform, apiKey, clientId}) });
    const data = await res.json();
    if (data.ok) {
      document.getElementById(`${platform}-api-key`).value = '';
      if (platform === 'ozon') document.getElementById('ozon-client-id').value = '';
      delete dataCache[platform];
      loadStatusBadges();
      alert(`âœ… ĞšĞ»ÑÑ‡Ğ¸ ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ñ‹! Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ¾Ğ±Ğ½Ğ¾Ğ²ÑÑ‚ÑÑ Ğ¿Ñ€Ğ¸ ÑĞ»ĞµĞ´ÑƒÑÑ‰ĞµĞ¼ Ğ¾Ñ‚ĞºÑ€Ñ‹Ñ‚Ğ¸Ğ¸ Ğ²ĞºĞ»Ğ°Ğ´ĞºĞ¸.`);
    } else { alert('âŒ ' + (data.error || 'ĞÑˆĞ¸Ğ±ĞºĞ°')); }
  } catch(e) { alert('âŒ ' + e.message); }
  finally { btn.disabled = false; btn.textContent = platform === 'ozon' ? 'Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ ĞºĞ»ÑÑ‡Ğ¸ Ozon' : 'Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ ĞºĞ»ÑÑ‡ WB'; }
}

// â”€â”€ Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ KPI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function saveAllKpi() {
  const fields = [
    {key:'revenue',id:'kpi-revenue'},{key:'daily_orders',id:'kpi-daily_orders'},
    {key:'ad_budget',id:'kpi-ad_budget'},{key:'conversion',id:'kpi-conversion'},
  ];
  let saved = 0;
  for (const f of fields) {
    const val = document.getElementById(f.id).value.trim();
    if (!val) continue;
    await fetch('/api/kpi', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({key:f.key,value:parseFloat(val)})});
    saved++;
  }
  dataCache['ozon'] = null; dataCache['wb'] = null;
  alert(saved ? `âœ… Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¾ Ğ¿Ğ»Ğ°Ğ½Ğ¾Ğ²: ${saved}` : 'Ğ—Ğ°Ğ¿Ğ¾Ğ»Ğ½Ğ¸ Ñ…Ğ¾Ñ‚Ñ Ğ±Ñ‹ Ğ¾Ğ´Ğ½Ğ¾ Ğ¿Ğ¾Ğ»Ğµ');
}

// â”€â”€ Ğ—Ğ°Ğ³Ñ€ÑƒĞ·Ğ¸Ñ‚ÑŒ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadSettingsPage() {
  loadStatusBadges();
  try {
    const res = await fetch('/api/kpi');
    const kpi = await res.json();
    const map = {revenue:'kpi-revenue',daily_orders:'kpi-daily_orders',ad_budget:'kpi-ad_budget',conversion:'kpi-conversion'};
    for (const [key, id] of Object.entries(map)) {
      if (kpi[key] !== undefined) document.getElementById(id).value = kpi[key];
    }
  } catch(e) {}
}

// â”€â”€ Ğ‘ĞµĞ¹Ğ´Ğ¶Ğ¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadStatusBadges() {
  try {
    const res  = await fetch('/api/credentials/status');
    const data = await res.json();
    document.getElementById('ozon-status-badge').innerHTML = data.ozon ? '<span class="badge-ok">âœ“ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡Ñ‘Ğ½</span>' : '<span class="badge-no">Ğ½Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½</span>';
    document.getElementById('wb-status-badge').innerHTML   = data.wb   ? '<span class="badge-ok">âœ“ Ğ¿Ğ¾Ğ´ĞºĞ»ÑÑ‡Ñ‘Ğ½</span>' : '<span class="badge-no">Ğ½Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½</span>';
  } catch(e) {}
}

// Ğ¡Ñ‚Ğ°Ñ€Ñ‚
loadPlatformData('ozon');
</script>
</body>
</html>
