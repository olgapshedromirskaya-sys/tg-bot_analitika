<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–æ–≤</title>
<link rel="stylesheet" href="assets/styles.css">
<style>
  /* ‚îÄ‚îÄ –í–∫–ª–∞–¥–∫–∏ ‚îÄ‚îÄ */
  .tabs {
    display: flex;
    position: sticky;
    top: 0;
    z-index: 200;
    background: var(--bg-card);
    border-bottom: 1px solid var(--line);
  }
  .tab-btn {
    flex: 1;
    padding: 13px 4px;
    font-size: 12px;
    font-weight: 700;
    font-family: inherit;
    color: var(--text-soft);
    background: none;
    border: none;
    border-bottom: 2px solid transparent;
    cursor: pointer;
    transition: all 0.2s;
  }
  .tab-btn.active {
    color: var(--cyan);
    border-bottom-color: var(--cyan);
    background: rgba(89,156,255,0.05);
  }
  .tab-panel { display: none; padding: 14px; }
  .tab-panel.active { display: block; }

  /* ‚îÄ‚îÄ –ö–∞—Ä—Ç–æ—á–∫–∏ –º–µ—Ç—Ä–∏–∫ ‚îÄ‚îÄ */
  .kpi-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    margin-bottom: 12px;
  }
  .kpi-card {
    background: var(--bg-card-strong, #151929);
    border: 1px solid var(--line);
    border-radius: 14px;
    padding: 12px;
  }
  .kpi-label { font-size: 11px; color: var(--text-soft); margin-bottom: 5px; }
  .kpi-value { font-size: 20px; font-weight: 800; line-height: 1; margin-bottom: 4px; }
  .kpi-delta { font-size: 11px; font-weight: 600; }
  .delta-up   { color: var(--green, #4caf50); }
  .delta-down { color: var(--orange, #ff8b57); }

  /* ‚îÄ‚îÄ –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä—ã ‚îÄ‚îÄ */
  .bar-card {
    background: var(--bg-card-strong, #151929);
    border: 1px solid var(--line);
    border-radius: 12px;
    padding: 11px 13px;
    margin-bottom: 7px;
  }
  .bar-header {
    display: flex;
    justify-content: space-between;
    font-size: 11px;
    color: var(--text-soft);
    margin-bottom: 7px;
  }
  .bar-header strong { color: var(--text-main); }
  .bar-track { height: 5px; background: var(--line); border-radius: 5px; overflow: hidden; }
  .bar-fill {
    height: 100%;
    border-radius: 5px;
    background: linear-gradient(90deg, var(--cyan, #599cff), var(--mint, #66cec3));
    transition: width 0.8s ease;
  }
  .bar-fill.warn { background: linear-gradient(90deg, #f5c518, #ff8b57); }

  /* ‚îÄ‚îÄ –°–µ–∫—Ü–∏–∏ ‚îÄ‚îÄ */
  .section-title {
    font-size: 10px;
    font-weight: 700;
    color: var(--text-soft);
    letter-spacing: 0.1em;
    text-transform: uppercase;
    margin: 16px 0 8px;
  }

  /* ‚îÄ‚îÄ –¢–æ–≤–∞—Ä—ã –≤ –∑–æ–Ω–µ —Ä–∏—Å–∫–∞ ‚îÄ‚îÄ */
  .risk-item {
    background: rgba(255,87,87,0.08);
    border: 1px solid rgba(255,87,87,0.25);
    border-radius: 12px;
    padding: 11px 13px;
    margin-bottom: 7px;
    display: flex;
    align-items: flex-start;
    gap: 10px;
  }
  .risk-icon { font-size: 18px; flex-shrink: 0; margin-top: 1px; }
  .risk-name { font-size: 13px; font-weight: 700; color: #ff6b6b; margin-bottom: 3px; }
  .risk-reason { font-size: 12px; color: var(--text-soft); line-height: 1.4; }
  .risk-sku { font-size: 10px; color: var(--text-soft); opacity: 0.6; margin-top: 2px; }

  /* ‚îÄ‚îÄ –¢–æ–≤–∞—Ä—ã —Å —Ä–æ—Å—Ç–æ–º ‚îÄ‚îÄ */
  .growth-item {
    background: rgba(76,175,80,0.08);
    border: 1px solid rgba(76,175,80,0.25);
    border-radius: 12px;
    padding: 11px 13px;
    margin-bottom: 7px;
    display: flex;
    align-items: flex-start;
    gap: 10px;
  }
  .growth-icon { font-size: 18px; flex-shrink: 0; margin-top: 1px; }
  .growth-name { font-size: 13px; font-weight: 700; color: #4caf50; margin-bottom: 3px; }
  .growth-reason { font-size: 12px; color: var(--text-soft); line-height: 1.4; }

  /* ‚îÄ‚îÄ –û—Å—Ç–∞—Ç–∫–∏ ‚îÄ‚îÄ */
  .stock-item {
    background: var(--bg-card-strong, #151929);
    border: 1px solid var(--line);
    border-radius: 12px;
    padding: 11px 13px;
    margin-bottom: 7px;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .stock-indicator {
    width: 10px; height: 10px;
    border-radius: 50%;
    flex-shrink: 0;
  }
  .stock-indicator.critical { background: #ff4444; box-shadow: 0 0 6px #ff4444; }
  .stock-indicator.warning  { background: #f5c518; box-shadow: 0 0 6px #f5c518; }
  .stock-indicator.ok       { background: #4caf50; box-shadow: 0 0 6px #4caf50; }
  .stock-info { flex: 1; min-width: 0; }
  .stock-name { font-size: 13px; font-weight: 700; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .stock-meta { font-size: 11px; color: var(--text-soft); }
  .stock-qty  { font-size: 16px; font-weight: 800; color: var(--text-main); flex-shrink: 0; }

  /* ‚îÄ‚îÄ –ö—Ä—É–≥–æ–≤–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞ ‚îÄ‚îÄ */
  .pie-wrap {
    background: var(--bg-card-strong, #151929);
    border: 1px solid var(--line);
    border-radius: 16px;
    padding: 16px;
    margin-bottom: 12px;
  }
  .pie-container {
    display: flex;
    align-items: center;
    gap: 16px;
  }
  .pie-svg-wrap { flex-shrink: 0; }
  .pie-legend { flex: 1; }
  .pie-legend-item {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
    font-size: 12px;
  }
  .pie-legend-dot {
    width: 10px; height: 10px;
    border-radius: 3px;
    flex-shrink: 0;
  }
  .pie-legend-name { color: var(--text-main); flex: 1; }
  .pie-legend-pct  { color: var(--text-soft); font-weight: 700; }
  .pie-legend-qty  { color: var(--text-soft); font-size: 11px; }

  /* ‚îÄ‚îÄ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚îÄ‚îÄ */
  .section-card {
    background: var(--bg-card);
    border: 1px solid var(--line);
    border-radius: 16px;
    padding: 14px;
    margin-bottom: 12px;
  }
  .section-heading {
    font-size: 11px;
    font-weight: 700;
    color: var(--text-soft);
    letter-spacing: 0.1em;
    text-transform: uppercase;
    margin-bottom: 10px;
  }
  .hint-box {
    background: rgba(89,156,255,0.08);
    border-radius: 10px;
    padding: 10px 12px;
    font-size: 12px;
    color: var(--text-soft);
    line-height: 1.6;
    margin-bottom: 12px;
  }
  .form-label { display: block; font-size: 12px; color: var(--text-soft); margin-bottom: 5px; }
  .form-input {
    width: 100%;
    background: var(--bg-card-strong, #151929);
    border: 1px solid var(--line);
    border-radius: 10px;
    padding: 11px 13px;
    color: var(--text-main);
    font-size: 14px;
    font-family: inherit;
    outline: none;
    margin-bottom: 9px;
    box-sizing: border-box;
    -webkit-appearance: none;
    transition: border-color 0.2s;
  }
  .form-input:focus { border-color: var(--cyan, #599cff); }
  .form-input::placeholder { color: var(--text-soft); opacity: 0.55; }
  .save-btn {
    width: 100%;
    padding: 12px;
    background: linear-gradient(135deg, var(--cyan, #599cff), var(--mint, #66cec3));
    border: none;
    border-radius: 12px;
    color: #07111f;
    font-weight: 800;
    font-size: 14px;
    font-family: inherit;
    cursor: pointer;
    box-sizing: border-box;
    transition: opacity 0.2s;
  }
  .save-btn:active { opacity: 0.8; }
  .save-btn:disabled { opacity: 0.5; cursor: default; }
  .badge-ok {
    display: inline-block;
    background: rgba(102,206,195,0.2);
    color: var(--mint, #66cec3);
    border-radius: 20px;
    padding: 1px 8px;
    font-size: 11px;
    font-weight: 700;
    margin-left: 6px;
  }
  .badge-no {
    display: inline-block;
    background: rgba(255,139,87,0.15);
    color: var(--orange, #ff8b57);
    border-radius: 20px;
    padding: 1px 8px;
    font-size: 11px;
    font-weight: 700;
    margin-left: 6px;
  }
  .s-divider { border: none; border-top: 1px solid var(--line); margin: 14px 0; }

  /* ‚îÄ‚îÄ –°–æ—Å—Ç–æ—è–Ω–∏—è ‚îÄ‚îÄ */
  .state-box { text-align: center; padding: 40px 16px; color: var(--text-soft); }
  .state-icon { font-size: 36px; margin-bottom: 10px; }
  .state-box p { font-size: 14px; line-height: 1.5; margin: 0 0 6px; }
  .state-box small { font-size: 12px; opacity: 0.65; }

  .platform-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 14px;
    padding-bottom: 10px;
    border-bottom: 1px solid var(--line);
  }
  .platform-dot { width: 9px; height: 9px; border-radius: 50%; }
  .platform-dot.ozon { background: #5b9fff; }
  .platform-dot.wb   { background: #cb11ab; }
  .platform-name { font-weight: 700; font-size: 14px; }
  .platform-updated { font-size: 11px; color: var(--text-soft); margin-left: auto; }
  .refresh-btn {
    background: none;
    border: 1px solid var(--line);
    border-radius: 8px;
    color: var(--text-soft);
    font-size: 12px;
    padding: 4px 10px;
    cursor: pointer;
    font-family: inherit;
  }

  /* ‚îÄ‚îÄ –ò—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö ‚îÄ‚îÄ */
  .source-badge {
    display: inline-block;
    font-size: 10px;
    padding: 2px 8px;
    border-radius: 20px;
    margin-left: 6px;
    font-weight: 600;
  }
  .source-api  { background: rgba(76,175,80,0.15); color: #4caf50; }
  .source-mock { background: rgba(245,197,24,0.15); color: #f5c518; }
  .delete-btn {
    background: rgba(255,80,80,0.12);
    border: 1px solid rgba(255,80,80,0.3);
    border-radius: 20px;
    color: #ff6b6b;
    font-size: 11px;
    font-weight: 700;
    padding: 2px 8px;
    cursor: pointer;
    font-family: inherit;
    margin-left: 4px;
    transition: background 0.2s;
  }
  .delete-btn:hover { background: rgba(255,80,80,0.25); }
</style>
</head>
<body>

<div class="tabs">
  <button class="tab-btn active" onclick="switchTab('ozon')">üîµ Ozon</button>
  <button class="tab-btn" onclick="switchTab('wb')">üü£ WB</button>
  <button class="tab-btn" onclick="switchTab('settings')">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
</div>

<!-- OZON -->
<div id="panel-ozon" class="tab-panel active">
  <div id="ozon-content">
    <div class="state-box"><div class="state-icon">‚è≥</div><p>–ó–∞–≥—Ä—É–∂–∞—é –¥–∞–Ω–Ω—ã–µ Ozon...</p></div>
  </div>
</div>

<!-- WB -->
<div id="panel-wb" class="tab-panel">
  <div id="wb-content">
    <div class="state-box"><div class="state-icon">‚è≥</div><p>–ó–∞–≥—Ä—É–∂–∞—é –¥–∞–Ω–Ω—ã–µ Wildberries...</p></div>
  </div>
</div>

<!-- –ù–ê–°–¢–†–û–ô–ö–ò -->
<div id="panel-settings" class="tab-panel">
  <div class="section-card">
    <div class="section-heading">üîë API-–∫–ª—é—á–∏ Ozon <span id="ozon-status-badge"></span></div>
    <div class="hint-box">
      seller.ozon.ru ‚Üí –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚öôÔ∏è ‚Üí API –∫–ª—é—á–∏ ‚Üí –°–æ–∑–¥–∞—Ç—å –∫–ª—é—á ‚Üí —Ç–∏–ø <strong>Admin</strong><br>
      –ù—É–∂–Ω—ã: <strong>Client-ID</strong> –∏ <strong>API-–∫–ª—é—á</strong>
    </div>
    <label class="form-label">Client-ID</label>
    <input id="ozon-client-id" class="form-input" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 123456" inputmode="numeric">
    <label class="form-label">API-–∫–ª—é—á</label>
    <input id="ozon-api-key" class="form-input" type="password" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ API-–∫–ª—é—á Ozon">
    <button class="save-btn" onclick="saveCredentials('ozon')">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–ª—é—á–∏ Ozon</button>
  </div>

  <div class="section-card">
    <div class="section-heading">üîë API-–∫–ª—é—á Wildberries <span id="wb-status-badge"></span></div>
    <div class="hint-box">
      seller.wildberries.ru ‚Üí –ü—Ä–æ—Ñ–∏–ª—å ‚Üí –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí –î–æ—Å—Ç—É–ø –∫ API ‚Üí –°–æ–∑–¥–∞—Ç—å —Ç–æ–∫–µ–Ω<br>
      –ì–∞–ª–æ—á–∫–∏: ‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ &nbsp;‚úÖ –†–µ–∫–ª–∞–º–∞ &nbsp;‚úÖ –ê–Ω–∞–ª–∏—Ç–∏–∫–∞
    </div>
    <label class="form-label">API-—Ç–æ–∫–µ–Ω</label>
    <input id="wb-api-key" class="form-input" type="password" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Ç–æ–∫–µ–Ω WB">
    <button class="save-btn" onclick="saveCredentials('wb')">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–ª—é—á WB</button>
  </div>

  <hr class="s-divider">

  <div class="section-card">
    <div class="section-heading">üéØ –ü–ª–∞–Ω—ã KPI –Ω–∞ –º–µ—Å—è—Ü</div>
    <div class="hint-box">–£–∫–∞–∂–∏ —Ü–µ–ª–∏ ‚Äî –±–æ—Ç —Å—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –∏ –ø—Ä–∏—Å—ã–ª–∞–µ—Ç –∞–ª–µ—Ä—Ç—ã.</div>
    <label class="form-label">üí∞ –í—ã—Ä—É—á–∫–∞ –∑–∞ –º–µ—Å—è—Ü, ‚ÇΩ</label>
    <input id="kpi-revenue" class="form-input" type="number" placeholder="5000000" inputmode="numeric">
    <label class="form-label">üì¶ –ó–∞–∫–∞–∑–æ–≤ –≤ –¥–µ–Ω—å, —à—Ç—É–∫</label>
    <input id="kpi-daily_orders" class="form-input" type="number" placeholder="100" inputmode="numeric">
    <label class="form-label">üì¢ –†–µ–∫–ª–∞–º–Ω—ã–π –±—é–¥–∂–µ—Ç –≤ –º–µ—Å—è—Ü, ‚ÇΩ</label>
    <input id="kpi-ad_budget" class="form-input" type="number" placeholder="100000" inputmode="numeric">
    <label class="form-label">üîÑ –¶–µ–ª–µ–≤–∞—è –∫–æ–Ω–≤–µ—Ä—Å–∏—è, %</label>
    <input id="kpi-conversion" class="form-input" type="number" step="0.1" placeholder="3.5" inputmode="decimal">
    <button class="save-btn" onclick="saveAllKpi()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–ª–∞–Ω—ã</button>
  </div>
</div>

<script>
// ‚îÄ‚îÄ Telegram WebApp ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
(function() {
  const tg = window.Telegram && window.Telegram.WebApp;
  if (!tg) return;
  try { tg.ready(); tg.expand(); tg.setBackgroundColor("#05060e"); tg.setHeaderColor("#05060e"); } catch(e) {}
})();

const dataCache = {};

// ‚îÄ‚îÄ –¶–≤–µ—Ç–∞ –¥–ª—è –∫—Ä—É–≥–æ–≤–æ–π –¥–∏–∞–≥—Ä–∞–º–º—ã ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const PIE_COLORS = [
  '#599cff','#66cec3','#f5c518','#ff8b57','#a78bfa',
  '#34d399','#f472b6','#60a5fa','#fbbf24','#4ade80'
];

// ‚îÄ‚îÄ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function switchTab(name) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  document.querySelector(`.tab-btn[onclick="switchTab('${name}')"]`).classList.add('active');
  document.getElementById(`panel-${name}`).classList.add('active');
  if (name === 'ozon')     loadPlatformData('ozon');
  if (name === 'wb')       loadPlatformData('wb');
  if (name === 'settings') loadSettingsPage();
}

// ‚îÄ‚îÄ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadPlatformData(platform, forceRefresh) {
  const el = document.getElementById(`${platform}-content`);
  if (dataCache[platform] && !forceRefresh) { el.innerHTML = dataCache[platform]; return; }

  el.innerHTML = `<div class="state-box"><div class="state-icon">‚è≥</div><p>–ó–∞–≥—Ä—É–∂–∞—é –¥–∞–Ω–Ω—ã–µ ${platform === 'ozon' ? 'Ozon' : 'Wildberries'}...</p></div>`;

  try {
    const controller = new AbortController();
    const timer = setTimeout(() => controller.abort(), 10000);
    const res  = await fetch(`/api/data/${platform}`, { signal: controller.signal });
    clearTimeout(timer);
    const data = await res.json();

    if (!res.ok || data.error) {
      el.innerHTML = `<div class="state-box"><div class="state-icon">üîë</div><p>${data.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏'}</p><small>–ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –≤–≤–µ–¥–∏—Ç–µ API-–∫–ª—é—á–∏</small></div>`;
      return;
    }

    const html = buildDashboard(data, platform);
    dataCache[platform] = html;
    el.innerHTML = html;
  } catch(e) {
    const msg = e.name === 'AbortError' ? '–°–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç (—Ç–∞–π–º–∞—É—Ç 10—Å)' : e.message;
    el.innerHTML = `<div class="state-box"><div class="state-icon">‚ùå</div><p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p><small>${msg}</small><br><button onclick="refreshData('${platform}')" style="margin-top:12px;padding:8px 16px;background:var(--cyan,#599cff);border:none;border-radius:8px;color:#fff;cursor:pointer;font-family:inherit">üîÑ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button></div>`;
  }
}

function refreshData(platform) { delete dataCache[platform]; loadPlatformData(platform, true); }

// ‚îÄ‚îÄ –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –¥–∞—à–±–æ—Ä–¥–∞ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function buildDashboard({ today, month, kpi, source, warehouses, stocks, atRiskProducts }, platform) {
  const t = today || {};
  const m = month || {};
  const k = kpi   || {};
  const now = new Date().toLocaleTimeString('ru', { hour: '2-digit', minute: '2-digit' });
  const isOzon = platform === 'ozon';

  const dayRevTarget = k.revenue      ? k.revenue / 30 : 0;
  const dayOrdTarget = k.daily_orders || 0;
  const adBudget     = k.ad_budget    || 0;
  const convTarget   = k.conversion   || 0;

  function fmtMoney(n) {
    n = n || 0;
    if (n >= 1000000) return (n/1000000).toFixed(1) + '–ú ‚ÇΩ';
    if (n >= 1000)    return Math.round(n/1000) + '–ö ‚ÇΩ';
    return n.toLocaleString('ru') + ' ‚ÇΩ';
  }
  function fmtNum(n) { return (n || 0).toLocaleString('ru'); }
  function pct(val, max) { return max ? Math.min((val/max)*100, 100).toFixed(0) : 0; }
  function deltaHtml(val, plan, higher = true) {
    if (!plan || !val) return '<span style="color:var(--text-soft);font-size:11px">‚Äî –Ω–µ—Ç –ø–ª–∞–Ω–∞</span>';
    const d = ((val/plan-1)*100).toFixed(1);
    const ok = higher ? val >= plan : val <= plan;
    return `<div class="kpi-delta ${ok?'delta-up':'delta-down'}">${ok?'‚ñ≤':'‚ñº'} ${Math.abs(d)}% –∫ –ø–ª–∞–Ω—É</div>`;
  }
  function barHtml(val, max, warn) {
    return `<div class="bar-track"><div class="bar-fill ${warn?'warn':''}" style="width:${pct(val,max)}%"></div></div>`;
  }

  const sourceBadge = source === 'api'
    ? '<span class="source-badge source-api">‚óè —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</span>'
    : '<span class="source-badge source-mock">‚óè –¥–µ–º–æ</span>';

  // ‚îÄ‚îÄ –¢–æ–≤–∞—Ä—ã –≤ –∑–æ–Ω–µ —Ä–∏—Å–∫–∞ ‚îÄ‚îÄ
  const riskItems = (atRiskProducts || []).filter(p => p.trend === 'down' || !p.trend);
  const growthItemsFromRisk = (atRiskProducts || []).filter(p => p.trend === 'up');
  let riskHtml = '';
  if (riskItems.length > 0) {
    riskHtml = `<div class="section-title">üö® –¢–æ–≤–∞—Ä—ã –≤ –∑–æ–Ω–µ —Ä–∏—Å–∫–∞</div>`;
    for (const p of riskItems) {
      const revenueArrow = (p.revenueDelta || 0) >= 0 ? '‚ñ≤' : '‚ñº';
      const revenueColor = (p.revenueDelta || 0) >= 0 ? '#4caf50' : '#ff4444';
      const ordersArrow  = (p.ordersDelta  || 0) >= 0 ? '‚ñ≤' : '‚ñº';
      const ordersColor  = (p.ordersDelta  || 0) >= 0 ? '#4caf50' : '#ff4444';
      const ctrArrow     = (p.ctrDelta     || 0) >= 0 ? '‚ñ≤' : '‚ñº';
      const ctrColor     = (p.ctrDelta     || 0) >= 0 ? '#4caf50' : '#ff4444';
      riskHtml += `
        <div class="risk-item">
          <div class="risk-icon">üö®</div>
          <div style="flex:1">
            <div class="risk-name">${p.name}${p.sku ? ` <span style="font-size:10px;opacity:0.6;font-weight:400">${p.sku}</span>` : ''}</div>
            <div class="risk-reason">${p.reason}</div>
            ${(p.revenueDelta !== undefined || p.ordersDelta !== undefined || p.ctrDelta !== undefined) ? `
            <div style="display:flex;gap:10px;margin-top:6px;flex-wrap:wrap">
              ${p.revenueDelta !== undefined ? `<span style="font-size:11px;font-weight:700;color:${revenueColor}">${revenueArrow} –í—ã—Ä—É—á–∫–∞ ${Math.abs(p.revenueDelta)}%</span>` : ''}
              ${p.ordersDelta  !== undefined ? `<span style="font-size:11px;font-weight:700;color:${ordersColor}">${ordersArrow} –ó–∞–∫–∞–∑—ã ${Math.abs(p.ordersDelta)}%</span>` : ''}
              ${p.ctrDelta     !== undefined ? `<span style="font-size:11px;font-weight:700;color:${ctrColor}">${ctrArrow} CTR ${Math.abs(p.ctrDelta)}%</span>` : ''}
            </div>` : ''}
          </div>
        </div>`;
    }
  }

  // ‚îÄ‚îÄ –¢–æ–≤–∞—Ä—ã —Å —Ä–æ—Å—Ç–æ–º ‚îÄ‚îÄ
  const growthItems = growthItemsFromRisk.length > 0
    ? growthItemsFromRisk
    : (stocks || []).filter(s => s.daysCover > 20).slice(0, 3);
  let growthHtml = '';
  if (growthItems.length > 0) {
    growthHtml = `<div class="section-title">üìà –†–æ—Å—Ç –ø—Ä–æ–¥–∞–∂</div>`;
    for (const p of growthItems) {
      const revenueArrow = (p.revenueDelta || 0) >= 0 ? '‚ñ≤' : '‚ñº';
      const ordersArrow  = (p.ordersDelta  || 0) >= 0 ? '‚ñ≤' : '‚ñº';
      const ctrArrow     = (p.ctrDelta     || 0) >= 0 ? '‚ñ≤' : '‚ñº';
      growthHtml += `
        <div class="growth-item">
          <div class="growth-icon">üìà</div>
          <div style="flex:1">
            <div class="growth-name">${p.name}${p.sku ? ` <span style="font-size:10px;opacity:0.6;font-weight:400">${p.sku}</span>` : ''}</div>
            <div class="growth-reason">${p.reason || ('–û—Å—Ç–∞—Ç–æ–∫: ' + fmtNum(p.qty) + ' —à—Ç ¬∑ –ü–æ–∫—Ä—ã—Ç–∏–µ: ' + p.daysCover + ' –¥–Ω')}</div>
            ${(p.revenueDelta !== undefined || p.ordersDelta !== undefined || p.ctrDelta !== undefined) ? `
            <div style="display:flex;gap:10px;margin-top:6px;flex-wrap:wrap">
              ${p.revenueDelta !== undefined ? `<span style="font-size:11px;font-weight:700;color:#4caf50">${revenueArrow} –í—ã—Ä—É—á–∫–∞ ${Math.abs(p.revenueDelta)}%</span>` : ''}
              ${p.ordersDelta  !== undefined ? `<span style="font-size:11px;font-weight:700;color:#4caf50">${ordersArrow} –ó–∞–∫–∞–∑—ã ${Math.abs(p.ordersDelta)}%</span>` : ''}
              ${p.ctrDelta     !== undefined ? `<span style="font-size:11px;font-weight:700;color:#4caf50">${ctrArrow} CTR ${Math.abs(p.ctrDelta)}%</span>` : ''}
            </div>` : ''}
          </div>
        </div>`;
    }
  }

  // ‚îÄ‚îÄ –û—Å—Ç–∞—Ç–∫–∏ –Ω–∞ —Å–∫–ª–∞–¥–∞—Ö ‚îÄ‚îÄ
  let stocksHtml = '';
  if (stocks && stocks.length > 0) {
    stocksHtml = `<div class="section-title">üì¶ –û—Å—Ç–∞—Ç–∫–∏ –Ω–∞ —Å–∫–ª–∞–¥–∞—Ö</div>`;
    for (const s of stocks.slice(0, 10)) {
      const level = s.daysCover < 7 ? 'critical' : s.daysCover < 14 ? 'warning' : 'ok';
      const label = s.daysCover < 7 ? 'üî¥ –∫—Ä–∏—Ç–∏—á–Ω–æ' : s.daysCover < 14 ? 'üü° –∫–æ–Ω—Ç—Ä–æ–ª—å' : 'üü¢ —Å—Ç–∞–±–∏–ª—å–Ω–æ';
      stocksHtml += `
        <div class="stock-item">
          <div class="stock-indicator ${level}"></div>
          <div class="stock-info">
            <div class="stock-name">${s.name}</div>
            <div class="stock-meta">${s.sku} ¬∑ ${s.warehouseName || ''} ¬∑ ${s.daysCover} –¥–Ω ¬∑ ${label}</div>
          </div>
          <div class="stock-qty">${fmtNum(s.qty)}</div>
        </div>`;
    }
  }

  // ‚îÄ‚îÄ –ö—Ä—É–≥–æ–≤–∞—è –¥–∏–∞–≥—Ä–∞–º–º–∞ —Å–∫–ª–∞–¥–æ–≤ ‚îÄ‚îÄ
  let pieHtml = '';
  if (warehouses && warehouses.length > 0) {
    const total = warehouses.reduce((s, w) => s + w.qty, 0);
    const top   = warehouses.slice(0, 8);

    // SVG –ø–∏—Ä–æ–≥
    const SIZE = 120, CX = 60, CY = 60, R = 50;
    let svgPaths = '';
    let startAngle = -Math.PI / 2;
    for (let i = 0; i < top.length; i++) {
      const slice = (top[i].qty / total) * 2 * Math.PI;
      const endAngle = startAngle + slice;
      const x1 = CX + R * Math.cos(startAngle);
      const y1 = CY + R * Math.sin(startAngle);
      const x2 = CX + R * Math.cos(endAngle);
      const y2 = CY + R * Math.sin(endAngle);
      const large = slice > Math.PI ? 1 : 0;
      const color = PIE_COLORS[i % PIE_COLORS.length];
      svgPaths += `<path d="M${CX},${CY} L${x1.toFixed(1)},${y1.toFixed(1)} A${R},${R} 0 ${large},1 ${x2.toFixed(1)},${y2.toFixed(1)} Z" fill="${color}" stroke="#0a0f1e" stroke-width="2"/>`;
      startAngle = endAngle;
    }

    // –õ–µ–≥–µ–Ω–¥–∞
    let legendHtml = '';
    for (let i = 0; i < top.length; i++) {
      const p = ((top[i].qty / total) * 100).toFixed(0);
      legendHtml += `
        <div class="pie-legend-item">
          <div class="pie-legend-dot" style="background:${PIE_COLORS[i % PIE_COLORS.length]}"></div>
          <div class="pie-legend-name">${top[i].name}</div>
          <div class="pie-legend-pct">${p}%</div>
        </div>
        <div style="font-size:11px;color:var(--text-soft);margin:-4px 0 6px 18px">${fmtNum(top[i].qty)} —à—Ç</div>`;
    }

    pieHtml = `
      <div class="section-title">üó∫Ô∏è –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Å–∫–ª–∞–¥–∞–º</div>
      <div class="pie-wrap">
        <div class="pie-container">
          <div class="pie-svg-wrap">
            <svg width="${SIZE}" height="${SIZE}" viewBox="0 0 ${SIZE} ${SIZE}">${svgPaths}</svg>
          </div>
          <div class="pie-legend">${legendHtml}</div>
        </div>
        <div style="font-size:11px;color:var(--text-soft);margin-top:10px;text-align:center">
          –í—Å–µ–≥–æ –Ω–∞ —Å–∫–ª–∞–¥–∞—Ö: <strong style="color:var(--text-main)">${fmtNum(total)} —à—Ç</strong>
        </div>
      </div>`;
  }

  return `
    <div class="platform-header">
      <div class="platform-dot ${platform}"></div>
      <div class="platform-name">${isOzon ? 'Ozon' : 'Wildberries'}${sourceBadge}</div>
      <div class="platform-updated">${now}</div>
      <button class="refresh-btn" onclick="refreshData('${platform}')">üîÑ</button>
    </div>

    <div class="section-title">–°–µ–≥–æ–¥–Ω—è</div>
    <div class="kpi-grid">
      <div class="kpi-card">
        <div class="kpi-label">üí∞ –í—ã—Ä—É—á–∫–∞</div>
        <div class="kpi-value" style="color:var(--mint,#66cec3)">${fmtMoney(t.revenue)}</div>
        ${deltaHtml(t.revenue, dayRevTarget)}
      </div>
      <div class="kpi-card">
        <div class="kpi-label">üì¶ –ó–∞–∫–∞–∑—ã</div>
        <div class="kpi-value">${fmtNum(t.orders)}</div>
        ${deltaHtml(t.orders, dayOrdTarget)}
      </div>
      <div class="kpi-card">
        <div class="kpi-label">üì¢ –†–µ–∫–ª–∞–º–∞</div>
        <div class="kpi-value" style="color:${t.adSpend > adBudget*0.85 ? 'var(--orange,#ff8b57)' : 'var(--yellow,#f5c518)'}">
          ${fmtMoney(t.adSpend)}
        </div>
        ${deltaHtml(t.adSpend, adBudget, false)}
      </div>
      <div class="kpi-card">
        <div class="kpi-label">üîÑ –ö–æ–Ω–≤–µ—Ä—Å–∏—è</div>
        <div class="kpi-value">${(t.conversion||0).toFixed(1)}%</div>
        ${deltaHtml(t.conversion, convTarget)}
      </div>
    </div>

    <div class="section-title">–ó–∞ –º–µ—Å—è—Ü</div>
    <div class="bar-card">
      <div class="bar-header"><span>–í—ã—Ä—É—á–∫–∞</span><strong>${fmtMoney(m.revenue)} / ${fmtMoney(k.revenue)}</strong></div>
      ${barHtml(m.revenue, k.revenue)}
    </div>
    <div class="bar-card">
      <div class="bar-header"><span>–ó–∞–∫–∞–∑—ã</span><strong>${fmtNum(m.orders)} / ${fmtNum(k.daily_orders*30)}</strong></div>
      ${barHtml(m.orders, k.daily_orders*30)}
    </div>
    <div class="bar-card">
      <div class="bar-header"><span>–†–µ–∫–ª–∞–º–Ω—ã–π –±—é–¥–∂–µ—Ç</span><strong>${fmtMoney(t.adSpend)} / ${fmtMoney(k.ad_budget)}</strong></div>
      ${barHtml(t.adSpend, k.ad_budget, t.adSpend > k.ad_budget*0.7)}
    </div>

    ${riskHtml}
    ${growthHtml}
    ${stocksHtml}
    ${pieHtml}
  `;
}

// ‚îÄ‚îÄ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å API-–∫–ª—é—á–∏ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function saveCredentials(platform) {
  const apiKey   = document.getElementById(`${platform}-api-key`).value.trim();
  const clientId = platform === 'ozon' ? document.getElementById('ozon-client-id').value.trim() : '';
  if (!apiKey) { alert('–í–≤–µ–¥–∏—Ç–µ API-–∫–ª—é—á'); return; }
  if (platform === 'ozon' && !clientId) { alert('–í–≤–µ–¥–∏—Ç–µ Client-ID –¥–ª—è Ozon'); return; }
  const btn = event.currentTarget;
  btn.disabled = true; btn.textContent = '–°–æ—Ö—Ä–∞–Ω—è—é...';
  try {
    const res  = await fetch('/api/credentials', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({platform, apiKey, clientId}) });
    const data = await res.json();
    if (data.ok) {
      document.getElementById(`${platform}-api-key`).value = '';
      if (platform === 'ozon') document.getElementById('ozon-client-id').value = '';
      delete dataCache[platform];
      loadStatusBadges();
      alert(`‚úÖ –ö–ª—é—á–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã! –î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤—è—Ç—Å—è –ø—Ä–∏ —Å–ª–µ–¥—É—é—â–µ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏ –≤–∫–ª–∞–¥–∫–∏.`);
    } else { alert('‚ùå ' + (data.error || '–û—à–∏–±–∫–∞')); }
  } catch(e) { alert('‚ùå ' + e.message); }
  finally { btn.disabled = false; btn.textContent = platform === 'ozon' ? '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–ª—é—á–∏ Ozon' : '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–ª—é—á WB'; }
}

// ‚îÄ‚îÄ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å KPI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function saveAllKpi() {
  const fields = [
    {key:'revenue',id:'kpi-revenue'},{key:'daily_orders',id:'kpi-daily_orders'},
    {key:'ad_budget',id:'kpi-ad_budget'},{key:'conversion',id:'kpi-conversion'},
  ];
  let saved = 0;
  for (const f of fields) {
    const val = document.getElementById(f.id).value.trim();
    if (!val) continue;
    await fetch('/api/kpi', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({key:f.key,value:parseFloat(val)})});
    saved++;
  }
  dataCache['ozon'] = null; dataCache['wb'] = null;
  alert(saved ? `‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –ø–ª–∞–Ω–æ–≤: ${saved}` : '–ó–∞–ø–æ–ª–Ω–∏ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –ø–æ–ª–µ');
}

// ‚îÄ‚îÄ –ó–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadSettingsPage() {
  loadStatusBadges();
  try {
    const res = await fetch('/api/kpi');
    const kpi = await res.json();
    const map = {revenue:'kpi-revenue',daily_orders:'kpi-daily_orders',ad_budget:'kpi-ad_budget',conversion:'kpi-conversion'};
    for (const [key, id] of Object.entries(map)) {
      if (kpi[key] !== undefined) document.getElementById(id).value = kpi[key];
    }
  } catch(e) {}
}

// ‚îÄ‚îÄ –ë–µ–π–¥–∂–∏ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadStatusBadges() {
  try {
    const res  = await fetch('/api/credentials/status');
    const data = await res.json();
    const ozonEl = document.getElementById('ozon-status-badge');
    const wbEl   = document.getElementById('wb-status-badge');
    ozonEl.innerHTML = data.ozon
      ? '<span class="badge-ok">&#10003; –ø–æ–¥–∫–ª—é—á—ë–Ω</span> <button class="delete-btn" id="btn-del-ozon">&#10005; –£–¥–∞–ª–∏—Ç—å</button>'
      : '<span class="badge-no">–Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω</span>';
    wbEl.innerHTML = data.wb
      ? '<span class="badge-ok">&#10003; –ø–æ–¥–∫–ª—é—á—ë–Ω</span> <button class="delete-btn" id="btn-del-wb">&#10005; –£–¥–∞–ª–∏—Ç—å</button>'
      : '<span class="badge-no">–Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω</span>';
    const btnOzon = document.getElementById('btn-del-ozon');
    const btnWb   = document.getElementById('btn-del-wb');
    if (btnOzon) btnOzon.addEventListener('click', function() { deleteCredentials('ozon'); });
    if (btnWb)   btnWb.addEventListener('click',   function() { deleteCredentials('wb'); });
  } catch(e) {}
}
async function deleteCredentials(platform) {
  const name = platform === 'ozon' ? 'Ozon' : 'Wildberries';
  if (!confirm(`–£–¥–∞–ª–∏—Ç—å –∫–ª—é—á–∏ ${name}? –î–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—Å—è –Ω–∞ –¥–µ–º–æ-—Ä–µ–∂–∏–º.`)) return;
  try {
    const res  = await fetch('/api/credentials/' + platform, { method: 'DELETE' });
    const data = await res.json();
    if (data.ok) {
      loadStatusBadges();
      alert('‚úÖ –ö–ª—é—á–∏ ' + name + ' —É–¥–∞–ª–µ–Ω—ã');
    } else {
      alert('‚ùå ' + (data.error || '–û—à–∏–±–∫–∞'));
    }
  } catch(e) {
    alert('‚ùå ' + e.message);
  }
}

// –°—Ç–∞—Ä—Ç
loadPlatformData('ozon');
</script>
</body>
</html>
