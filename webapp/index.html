<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–æ–≤</title>
<link rel="stylesheet" href="assets/styles.css">
<style>
  .tabs {
    display: flex;
    background: var(--bg-card);
    border-bottom: 1px solid var(--line);
    position: sticky;
    top: 0;
    z-index: 100;
  }
  .tab-btn {
    flex: 1;
    padding: 14px 8px;
    text-align: center;
    cursor: pointer;
    font-weight: 700;
    font-size: 13px;
    color: var(--text-soft);
    border-bottom: 2px solid transparent;
    border-top: none;
    border-left: none;
    border-right: none;
    background: none;
    font-family: inherit;
    transition: all 0.2s;
  }
  .tab-btn.active {
    color: var(--cyan);
    border-bottom-color: var(--cyan);
    background: rgba(89,156,255,0.06);
  }

  .tab-panel { display: none; padding: 16px; }
  .tab-panel.active { display: block; }

  .kpi-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 10px;
    margin-bottom: 14px;
  }
  .kpi-card {
    background: var(--bg-card-strong);
    border: 1px solid var(--line);
    border-radius: 14px;
    padding: 14px;
  }
  .kpi-label { font-size: 11px; color: var(--text-soft); margin-bottom: 6px; }
  .kpi-value { font-size: 22px; font-weight: 800; line-height: 1; margin-bottom: 4px; color: var(--text-main); }
  .kpi-delta { font-size: 11px; font-weight: 600; }
  .delta-up   { color: var(--green); }
  .delta-down { color: var(--orange); }

  .bar-card {
    background: var(--bg-card-strong);
    border: 1px solid var(--line);
    border-radius: 12px;
    padding: 12px 14px;
    margin-bottom: 8px;
  }
  .bar-header {
    display: flex;
    justify-content: space-between;
    font-size: 12px;
    color: var(--text-soft);
    margin-bottom: 8px;
  }
  .bar-header strong { color: var(--text-main); }
  .bar-track { height: 6px; background: var(--line); border-radius: 6px; overflow: hidden; }
  .bar-fill {
    height: 100%;
    border-radius: 6px;
    background: linear-gradient(90deg, var(--cyan), var(--mint));
    transition: width 0.8s ease;
  }
  .bar-fill.warn { background: linear-gradient(90deg, var(--yellow), var(--orange)); }

  .alert-card {
    background: rgba(255,139,87,0.1);
    border: 1px solid rgba(255,139,87,0.3);
    border-radius: 12px;
    padding: 12px 14px;
    margin-bottom: 10px;
    font-size: 13px;
    line-height: 1.5;
  }
  .alert-title { color: var(--orange); font-weight: 700; margin-bottom: 4px; }

  .section-title {
    font-size: 11px;
    font-weight: 700;
    color: var(--text-soft);
    letter-spacing: 0.1em;
    text-transform: uppercase;
    margin: 20px 0 10px;
  }
  .section-card {
    background: var(--bg-card);
    border: 1px solid var(--line);
    border-radius: 16px;
    padding: 16px;
    margin-bottom: 14px;
  }

  .form-label {
    display: block;
    font-size: 12px;
    color: var(--text-soft);
    margin-bottom: 6px;
  }
  .form-input {
    width: 100%;
    background: var(--bg-card-strong);
    border: 1px solid var(--line);
    border-radius: 10px;
    padding: 12px 14px;
    color: var(--text-main);
    font-size: 14px;
    font-family: inherit;
    outline: none;
    margin-bottom: 10px;
    transition: border-color 0.2s;
    -webkit-appearance: none;
    box-sizing: border-box;
  }
  .form-input:focus { border-color: var(--cyan); }
  .form-input::placeholder { color: var(--text-soft); opacity: 0.6; }

  .save-btn {
    width: 100%;
    padding: 13px;
    background: linear-gradient(135deg, var(--cyan), var(--mint));
    border: none;
    border-radius: 12px;
    color: #0a1628;
    font-weight: 800;
    font-size: 14px;
    cursor: pointer;
    font-family: inherit;
    transition: opacity 0.2s;
    margin-top: 2px;
    box-sizing: border-box;
  }
  .save-btn:active { opacity: 0.8; }
  .save-btn:disabled { opacity: 0.5; cursor: default; }

  .hint-box {
    background: rgba(89,156,255,0.08);
    border-radius: 10px;
    padding: 10px 12px;
    font-size: 12px;
    color: var(--text-soft);
    line-height: 1.6;
    margin-bottom: 14px;
  }

  .badge-ok {
    display: inline-block;
    background: rgba(102,206,195,0.2);
    color: var(--mint);
    border-radius: 20px;
    padding: 1px 8px;
    font-size: 11px;
    font-weight: 700;
  }
  .badge-no {
    display: inline-block;
    background: rgba(255,139,87,0.15);
    color: var(--orange);
    border-radius: 20px;
    padding: 1px 8px;
    font-size: 11px;
    font-weight: 700;
  }

  .divider { border: none; border-top: 1px solid var(--line); margin: 18px 0; }

  .state-box {
    text-align: center;
    padding: 48px 20px;
    color: var(--text-soft);
  }
  .state-box .state-icon { font-size: 40px; margin-bottom: 12px; }
  .state-box p { font-size: 14px; line-height: 1.5; }
  .state-box small { font-size: 12px; opacity: 0.7; }

  .platform-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 16px;
    padding-bottom: 12px;
    border-bottom: 1px solid var(--line);
  }
  .platform-dot { width: 10px; height: 10px; border-radius: 50%; }
  .platform-dot.ozon { background: #5b9fff; }
  .platform-dot.wb   { background: #cb11ab; }
  .platform-name { font-weight: 700; font-size: 15px; }
  .platform-updated { font-size: 11px; color: var(--text-soft); margin-left: auto; }

  .refresh-btn {
    background: none;
    border: 1px solid var(--line);
    border-radius: 8px;
    color: var(--text-soft);
    font-size: 12px;
    padding: 5px 12px;
    cursor: pointer;
    font-family: inherit;
  }
</style>
</head>
<body>

<div class="tabs">
  <button class="tab-btn active" onclick="switchTab('ozon')">üîµ Ozon</button>
  <button class="tab-btn" onclick="switchTab('wb')">üü£ WB</button>
  <button class="tab-btn" onclick="switchTab('settings')">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
</div>

<!-- OZON -->
<div id="panel-ozon" class="tab-panel active">
  <div id="ozon-content">
    <div class="state-box">
      <div class="state-icon">‚è≥</div>
      <p>–ó–∞–≥—Ä—É–∂–∞—é –¥–∞–Ω–Ω—ã–µ Ozon...</p>
    </div>
  </div>
</div>

<!-- WB -->
<div id="panel-wb" class="tab-panel">
  <div id="wb-content">
    <div class="state-box">
      <div class="state-icon">‚è≥</div>
      <p>–ó–∞–≥—Ä—É–∂–∞—é –¥–∞–Ω–Ω—ã–µ Wildberries...</p>
    </div>
  </div>
</div>

<!-- –ù–ê–°–¢–†–û–ô–ö–ò -->
<div id="panel-settings" class="tab-panel">

  <div class="section-card">
    <div class="section-title">üîë API-–∫–ª—é—á–∏ Ozon <span id="ozon-status-badge"></span></div>
    <div class="hint-box">
      <strong>–ì–¥–µ –≤–∑—è—Ç—å:</strong> seller.ozon.ru ‚Üí –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚öôÔ∏è ‚Üí API –∫–ª—é—á–∏ ‚Üí –°–æ–∑–¥–∞—Ç—å –∫–ª—é—á ‚Üí —Ç–∏–ø <strong>Admin</strong><br>
      –°–∫–æ–ø–∏—Ä—É–π <strong>Client-ID</strong> (—á–∏—Å–ª–æ) –∏ <strong>API-–∫–ª—é—á</strong> (–¥–ª–∏–Ω–Ω–∞—è —Å—Ç—Ä–æ–∫–∞)
    </div>
    <label class="form-label">Client-ID</label>
    <input id="ozon-client-id" class="form-input" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 123456" inputmode="numeric">
    <label class="form-label">API-–∫–ª—é—á</label>
    <input id="ozon-api-key" class="form-input" type="password" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ API-–∫–ª—é—á Ozon">
    <button class="save-btn" onclick="saveCredentials('ozon')">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–ª—é—á–∏ Ozon</button>
  </div>

  <div class="section-card">
    <div class="section-title">üîë API-–∫–ª—é—á Wildberries <span id="wb-status-badge"></span></div>
    <div class="hint-box">
      <strong>–ì–¥–µ –≤–∑—è—Ç—å:</strong> seller.wildberries.ru ‚Üí –ü—Ä–æ—Ñ–∏–ª—å (–∏–º—è —Å–ø—Ä–∞–≤–∞ –≤–≤–µ—Ä—Ö—É) ‚Üí –ù–∞—Å—Ç—Ä–æ–π–∫–∏ ‚Üí –î–æ—Å—Ç—É–ø –∫ API ‚Üí –°–æ–∑–¥–∞—Ç—å —Ç–æ–∫–µ–Ω<br>
      –ì–∞–ª–æ—á–∫–∏: ‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ &nbsp;‚úÖ –†–µ–∫–ª–∞–º–∞ &nbsp;‚úÖ –ê–Ω–∞–ª–∏—Ç–∏–∫–∞
    </div>
    <label class="form-label">API-—Ç–æ–∫–µ–Ω</label>
    <input id="wb-api-key" class="form-input" type="password" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Ç–æ–∫–µ–Ω WB">
    <button class="save-btn" onclick="saveCredentials('wb')">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–ª—é—á WB</button>
  </div>

  <hr class="divider">

  <div class="section-card">
    <div class="section-title">üéØ –ü–ª–∞–Ω—ã KPI –Ω–∞ –º–µ—Å—è—Ü</div>
    <div class="hint-box">
      –£–∫–∞–∂–∏ —Å–≤–æ–∏ —Ü–µ–ª–∏. –ë–æ—Ç —Å—Ä–∞–≤–Ω–∏–≤–∞–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å –ø–ª–∞–Ω–∞–º–∏ –∏ –ø—Ä–∏—Å—ã–ª–∞–µ—Ç –∞–ª–µ—Ä—Ç—ã –ø—Ä–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è—Ö.
    </div>
    <label class="form-label">üí∞ –í—ã—Ä—É—á–∫–∞ –∑–∞ –º–µ—Å—è—Ü, ‚ÇΩ</label>
    <input id="kpi-revenue" class="form-input" type="number" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 5000000" inputmode="numeric">
    <label class="form-label">üì¶ –ó–∞–∫–∞–∑–æ–≤ –≤ –¥–µ–Ω—å, —à—Ç—É–∫</label>
    <input id="kpi-daily_orders" class="form-input" type="number" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 100" inputmode="numeric">
    <label class="form-label">üì¢ –†–µ–∫–ª–∞–º–Ω—ã–π –±—é–¥–∂–µ—Ç –≤ –º–µ—Å—è—Ü, ‚ÇΩ</label>
    <input id="kpi-ad_budget" class="form-input" type="number" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 100000" inputmode="numeric">
    <label class="form-label">üîÑ –¶–µ–ª–µ–≤–∞—è –∫–æ–Ω–≤–µ—Ä—Å–∏—è, %</label>
    <input id="kpi-conversion" class="form-input" type="number" step="0.1" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 3.5" inputmode="decimal">
    <button class="save-btn" onclick="saveAllKpi()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–ª–∞–Ω—ã</button>
  </div>

</div>

<script>
// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp
(function() {
  const tg = window.Telegram && window.Telegram.WebApp;
  if (!tg) return;
  try {
    tg.ready();
    tg.expand();
    tg.setBackgroundColor("#05060e");
    tg.setHeaderColor("#05060e");
  } catch(e) {}
})();

const dataCache = {};

// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫
function switchTab(name) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
  document.querySelector(`.tab-btn[onclick="switchTab('${name}')"]`).classList.add('active');
  document.getElementById(`panel-${name}`).classList.add('active');

  if (name === 'ozon')     loadPlatformData('ozon');
  if (name === 'wb')       loadPlatformData('wb');
  if (name === 'settings') loadSettingsPage();
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
async function loadPlatformData(platform, forceRefresh) {
  const el = document.getElementById(`${platform}-content`);

  if (dataCache[platform] && !forceRefresh) {
    el.innerHTML = dataCache[platform];
    return;
  }

  const platformName = platform === 'ozon' ? 'Ozon' : 'Wildberries';
  el.innerHTML = `<div class="state-box"><div class="state-icon">‚è≥</div><p>–ó–∞–≥—Ä—É–∂–∞—é –¥–∞–Ω–Ω—ã–µ ${platformName}...</p></div>`;

  try {
    const res  = await fetch(`/api/data/${platform}`);
    const data = await res.json();

    if (!res.ok || data.error) {
      el.innerHTML = `
        <div class="state-box">
          <div class="state-icon">üîë</div>
          <p>${data.error || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏'}</p>
          <small>–ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –≤–≤–µ–¥–∏—Ç–µ API-–∫–ª—é—á–∏</small>
        </div>`;
      return;
    }

    const html = buildDashboard(data, platform);
    dataCache[platform] = html;
    el.innerHTML = html;
  } catch(e) {
    el.innerHTML = `<div class="state-box"><div class="state-icon">‚ùå</div><p>–ù–µ—Ç —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º</p><small>${e.message}</small></div>`;
  }
}

// –ü–æ—Å—Ç—Ä–æ–µ–Ω–∏–µ –¥–∞—à–±–æ—Ä–¥–∞
function buildDashboard({ today, month, kpi, error }, platform) {
  const t = today || {};
  const m = month || {};
  const k = kpi   || {};
  const now = new Date().toLocaleTimeString('ru', { hour: '2-digit', minute: '2-digit' });
  const isOzon = platform === 'ozon';

  const dayRevTarget = k.revenue      ? k.revenue / 30  : 0;
  const dayOrdTarget = k.daily_orders ? k.daily_orders   : 0;
  const adBudget     = k.ad_budget    ? k.ad_budget      : 0;
  const convTarget   = k.conversion   ? k.conversion     : 0;

  function fmtMoney(n) {
    n = n || 0;
    if (n >= 1000000) return (n / 1000000).toFixed(1) + '–ú ‚ÇΩ';
    if (n >= 1000)    return Math.round(n / 1000) + '–ö ‚ÇΩ';
    return n.toLocaleString('ru') + ' ‚ÇΩ';
  }
  function fmtNum(n) { return (n || 0).toLocaleString('ru'); }
  function pct(val, max) { return max ? Math.min((val / max) * 100, 100).toFixed(0) : 0; }

  function deltaHtml(val, plan, higher) {
    if (higher === undefined) higher = true;
    if (!plan || !val) return '<span style="color:var(--text-soft);font-size:11px">‚Äî –Ω–µ—Ç –ø–ª–∞–Ω–∞</span>';
    const d  = ((val / plan - 1) * 100).toFixed(1);
    const ok = higher ? val >= plan : val <= plan;
    return `<div class="kpi-delta ${ok ? 'delta-up' : 'delta-down'}">${ok ? '‚ñ≤' : '‚ñº'} ${Math.abs(d)}% –∫ –ø–ª–∞–Ω—É</div>`;
  }

  function barHtml(val, max, warn) {
    const p = pct(val, max);
    return `<div class="bar-track"><div class="bar-fill ${warn ? 'warn' : ''}" style="width:${p}%"></div></div>`;
  }

  // –ê–ª–µ—Ä—Ç—ã
  let alerts = '';
  if (adBudget && t.adSpend > adBudget * 0.85) {
    alerts += `<div class="alert-card"><div class="alert-title">üí∏ –†–µ–∫–ª–∞–º–Ω—ã–π –±—é–¥–∂–µ—Ç –Ω–∞ –∏—Å—Ö–æ–¥–µ</div>–ü–æ—Ç—Ä–∞—á–µ–Ω–æ ${fmtMoney(t.adSpend)} –∏–∑ ${fmtMoney(adBudget)} (${pct(t.adSpend, adBudget)}%)</div>`;
  }
  if (convTarget && t.conversion && t.conversion < convTarget * 0.7) {
    alerts += `<div class="alert-card"><div class="alert-title">üìâ –ù–∏–∑–∫–∞—è –∫–æ–Ω–≤–µ—Ä—Å–∏—è</div>–°–µ–π—á–∞—Å ${t.conversion}% –ø—Ä–∏ —Ü–µ–ª–∏ ${convTarget}%. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–∞—Ä—Ç–æ—á–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤.</div>`;
  }
  if (error) {
    alerts += `<div class="alert-card"><div class="alert-title">‚ö†Ô∏è –û—à–∏–±–∫–∞ API</div>${error}</div>`;
  }

  return `
    <div class="platform-header">
      <div class="platform-dot ${platform}"></div>
      <div class="platform-name">${isOzon ? 'Ozon' : 'Wildberries'}</div>
      <div class="platform-updated">–æ–±–Ω–æ–≤–ª–µ–Ω–æ –≤ ${now}</div>
      <button class="refresh-btn" onclick="refreshData('${platform}')">üîÑ</button>
    </div>

    ${alerts}

    <div class="section-title">–°–µ–≥–æ–¥–Ω—è</div>
    <div class="kpi-grid">
      <div class="kpi-card">
        <div class="kpi-label">üí∞ –í—ã—Ä—É—á–∫–∞</div>
        <div class="kpi-value" style="color:var(--mint)">${fmtMoney(t.revenue)}</div>
        ${deltaHtml(t.revenue, dayRevTarget)}
      </div>
      <div class="kpi-card">
        <div class="kpi-label">üì¶ –ó–∞–∫–∞–∑—ã</div>
        <div class="kpi-value">${fmtNum(t.orders)}</div>
        ${deltaHtml(t.orders, dayOrdTarget)}
      </div>
      <div class="kpi-card">
        <div class="kpi-label">üì¢ –†–µ–∫–ª–∞–º–∞</div>
        <div class="kpi-value" style="color:${t.adSpend > adBudget * 0.85 ? 'var(--orange)' : 'var(--yellow)'}">
          ${fmtMoney(t.adSpend)}
        </div>
        ${deltaHtml(t.adSpend, adBudget, false)}
      </div>
      <div class="kpi-card">
        <div class="kpi-label">üîÑ –ö–æ–Ω–≤–µ—Ä—Å–∏—è</div>
        <div class="kpi-value">${(t.conversion || 0).toFixed(1)}%</div>
        ${deltaHtml(t.conversion, convTarget)}
      </div>
    </div>

    <div class="section-title">–ó–∞ –º–µ—Å—è—Ü</div>
    <div class="bar-card">
      <div class="bar-header"><span>–í—ã—Ä—É—á–∫–∞</span><strong>${fmtMoney(m.revenue)} / ${fmtMoney(k.revenue)}</strong></div>
      ${barHtml(m.revenue, k.revenue)}
    </div>
    <div class="bar-card">
      <div class="bar-header"><span>–ó–∞–∫–∞–∑—ã</span><strong>${fmtNum(m.orders)} / ${fmtNum(k.daily_orders * 30)}</strong></div>
      ${barHtml(m.orders, k.daily_orders * 30)}
    </div>
    <div class="bar-card">
      <div class="bar-header"><span>–†–µ–∫–ª–∞–º–Ω—ã–π –±—é–¥–∂–µ—Ç</span><strong>${fmtMoney(t.adSpend)} / ${fmtMoney(k.ad_budget)}</strong></div>
      ${barHtml(t.adSpend, k.ad_budget, t.adSpend > k.ad_budget * 0.7)}
    </div>
  `;
}

// –û–±–Ω–æ–≤–∏—Ç—å (—Å–±—Ä–æ—Å–∏—Ç—å –∫—ç—à)
function refreshData(platform) {
  delete dataCache[platform];
  loadPlatformData(platform, true);
}

// –°–æ—Ö—Ä–∞–Ω–∏—Ç—å API-–∫–ª—é—á–∏
async function saveCredentials(platform) {
  const apiKey   = document.getElementById(`${platform}-api-key`).value.trim();
  const clientId = platform === 'ozon' ? document.getElementById('ozon-client-id').value.trim() : '';

  if (!apiKey) { alert('–í–≤–µ–¥–∏—Ç–µ API-–∫–ª—é—á'); return; }
  if (platform === 'ozon' && !clientId) { alert('–í–≤–µ–¥–∏—Ç–µ Client-ID –¥–ª—è Ozon'); return; }

  const btn = event.currentTarget;
  btn.disabled = true;
  btn.textContent = '–°–æ—Ö—Ä–∞–Ω—è—é...';

  try {
    const res  = await fetch('/api/credentials', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ platform, apiKey, clientId }),
    });
    const data = await res.json();

    if (data.ok) {
      document.getElementById(`${platform}-api-key`).value = '';
      if (platform === 'ozon') document.getElementById('ozon-client-id').value = '';
      delete dataCache[platform];
      loadStatusBadges();
      alert(`‚úÖ –ö–ª—é—á–∏ ${platform === 'ozon' ? 'Ozon' : 'WB'} —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!\n\n–ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ –≤–∫–ª–∞–¥–∫—É ${platform === 'ozon' ? 'üîµ Ozon' : 'üü£ WB'} –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–∞–Ω–Ω—ã—Ö.`);
    } else {
      alert('‚ùå ' + (data.error || '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è'));
    }
  } catch(e) {
    alert('‚ùå –û—à–∏–±–∫–∞: ' + e.message);
  } finally {
    btn.disabled = false;
    btn.textContent = `–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–ª—é—á–∏ ${platform === 'ozon' ? 'Ozon' : 'WB'}`;
  }
}

// –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å–µ KPI
async function saveAllKpi() {
  const fields = [
    { key: 'revenue',      id: 'kpi-revenue' },
    { key: 'daily_orders', id: 'kpi-daily_orders' },
    { key: 'ad_budget',    id: 'kpi-ad_budget' },
    { key: 'conversion',   id: 'kpi-conversion' },
  ];

  let saved = 0;
  for (const f of fields) {
    const val = document.getElementById(f.id).value.trim();
    if (!val) continue;
    await fetch('/api/kpi', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ key: f.key, value: parseFloat(val) }),
    });
    saved++;
  }

  dataCache['ozon'] = null;
  dataCache['wb']   = null;
  alert(saved ? `‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –ø–ª–∞–Ω–æ–≤: ${saved}` : '–ó–∞–ø–æ–ª–Ω–∏ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –ø–æ–ª–µ');
}

// –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –Ω–∞—Å—Ç—Ä–æ–µ–∫
async function loadSettingsPage() {
  loadStatusBadges();
  try {
    const res = await fetch('/api/kpi');
    const kpi = await res.json();
    const map = {
      revenue:      'kpi-revenue',
      daily_orders: 'kpi-daily_orders',
      ad_budget:    'kpi-ad_budget',
      conversion:   'kpi-conversion',
    };
    for (const [key, id] of Object.entries(map)) {
      if (kpi[key] !== undefined) document.getElementById(id).value = kpi[key];
    }
  } catch(e) {}
}

// –ë–µ–π–¥–∂–∏ —Å—Ç–∞—Ç—É—Å–∞ –∫–ª—é—á–µ–π
async function loadStatusBadges() {
  try {
    const res  = await fetch('/api/credentials/status');
    const data = await res.json();
    document.getElementById('ozon-status-badge').innerHTML = data.ozon
      ? '<span class="badge-ok">‚úì –ø–æ–¥–∫–ª—é—á—ë–Ω</span>'
      : '<span class="badge-no">–Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω</span>';
    document.getElementById('wb-status-badge').innerHTML = data.wb
      ? '<span class="badge-ok">‚úì –ø–æ–¥–∫–ª—é—á—ë–Ω</span>'
      : '<span class="badge-no">–Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω</span>';
  } catch(e) {}
}

// –°—Ç–∞—Ä—Ç
loadPlatformData('ozon');
</script>

</body>
</html>